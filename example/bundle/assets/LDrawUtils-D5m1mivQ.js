import{e as z,M as U,z as oe,g as te,i as _e,C as ie,m as B,a0 as Ce,l as Oe,aq as Me,K as Le,B as V,Y as $,X as be,as as Re}from"./MaterialBase-byhyp4gt.js";import{m as Z}from"./BufferGeometryUtils-DMgFFDwZ.js";const le=0,ce=1,he=2,ue=3,de=4,ge=5,J=0,Ve=1,Ge=2,Pe=3,We=4,Ue=5,me=6,P="16",j="24",q=_e,K=new B,X=new B;class Be extends ${constructor(e,t){super(e,t),this.isConditionalLine=!0}}function je(I){for(let e=0,t=I.length;e<t;e++){const r=I[e],n=r.vertices,m=n[0],L=n[1],i=n[2];K.subVectors(L,m),X.subVectors(i,L),r.faceNormal=new B().crossVectors(K,X).normalize()}}const pe=new Me;function Ye(I,e,t=!1){const r=100.00000001000001;function n(o){const l=~~(o.x*r),h=~~(o.y*r),a=~~(o.z*r);return`${l},${h},${a}`}function m(o,l){return`${n(o)}_${n(l)}`}function L(o,l,h){h.direction.subVectors(l,o).normalize();const a=o.dot(h.direction);return h.origin.copy(o).addScaledVector(h.direction,-a),h}function i(o){return m(o.origin,o.direction)}const d=new Set,c=new Map,A={},k=[];for(let o=0,l=e.length;o<l;o++){const a=e[o].vertices,g=a[0],u=a[1];if(d.add(m(g,u)),d.add(m(u,g)),t){const C=L(g,u,new Me),f=i(C);if(!c.has(f)){L(u,g,C);const T=i(C),v={ray:C,distances:[]};c.set(f,v),c.set(T,v)}const b=c.get(f);let M=b.ray.direction.dot(g),y=b.ray.direction.dot(u);M>y&&([M,y]=[y,M]),b.distances.push(M,y)}}for(let o=0,l=I.length;o<l;o++){const h=I[o],a=h.vertices,g=a.length;for(let u=0;u<g;u++){const C=u,f=(u+1)%g,b=a[C],M=a[f],y=m(b,M);if(d.has(y))continue;if(t){L(b,M,pe);const v=i(pe);if(c.has(v)){const F=c.get(v),{ray:x,distances:s}=F;let E=x.direction.dot(b),w=x.direction.dot(M);E>w&&([E,w]=[w,E]);let p=!1;for(let S=0,D=s.length;S<D;S+=2)if(E>=s[S]&&w<=s[S+1]){p=!0;break}if(p)continue}}const T={index:C,tri:h};A[y]=T}}for(;;){let o=null;for(const h in A){o=A[h];break}if(o===null)break;const l=[o];for(;l.length>0;){const h=l.pop().tri,a=h.vertices,g=h.normals,u=h.faceNormal,C=a.length;for(let f=0;f<C;f++){const b=f,M=(f+1)%C,y=a[b],T=a[M],v=m(y,T);delete A[v];const F=m(T,y),x=A[F];if(x){const s=x.tri,E=x.index,w=s.normals,p=w.length,S=s.faceNormal;if(Math.abs(s.faceNormal.dot(h.faceNormal))<.25)continue;F in A&&(l.push(x),delete A[F]);const D=(E+1)%p;g[b]&&w[D]&&g[b]!==w[D]&&(w[D].norm.add(g[b].norm),g[b].norm=w[D].norm);let _=g[b]||w[D];_===null&&(_={norm:new B},k.push(_.norm)),g[b]===null&&(g[b]=_,_.norm.add(u)),w[D]===null&&(w[D]=_,_.norm.add(S)),g[M]&&w[E]&&g[M]!==w[E]&&(w[E].norm.add(g[M].norm),g[M].norm=w[E].norm);let N=g[M]||w[E];N===null&&(N={norm:new B},k.push(N.norm)),g[M]===null&&(g[M]=N,N.norm.add(u)),w[E]===null&&(w[E]=N,N.norm.add(S))}}}}for(let o=0,l=k.length;o<l;o++)k[o].normalize()}function fe(I){return I==="Part"||I==="Unofficial_Part"}function He(I){return/primitive/i.test(I)||I==="Subpart"}class Y{constructor(e,t){this.line=e,this.lineLength=e.length,this.currentCharIndex=0,this.currentChar=" ",this.lineNumber=t}seekNonSpace(){for(;this.currentCharIndex<this.lineLength;){if(this.currentChar=this.line.charAt(this.currentCharIndex),this.currentChar!==" "&&this.currentChar!=="	")return;this.currentCharIndex++}}getToken(){const e=this.currentCharIndex++;for(;this.currentCharIndex<this.lineLength&&(this.currentChar=this.line.charAt(this.currentCharIndex),!(this.currentChar===" "||this.currentChar==="	"));)this.currentCharIndex++;const t=this.currentCharIndex;return this.seekNonSpace(),this.line.substring(e,t)}getVector(){return new B(parseFloat(this.getToken()),parseFloat(this.getToken()),parseFloat(this.getToken()))}getRemainingString(){return this.line.substring(this.currentCharIndex,this.lineLength)}isAtTheEnd(){return this.currentCharIndex>=this.lineLength}setToEnd(){this.currentCharIndex=this.lineLength}getLineNumberString(){return this.lineNumber>=0?" at line "+this.lineNumber:""}}class ze{constructor(e){this.loader=e,this._cache={}}cloneResult(e){const t={};return t.faces=e.faces.map(r=>({colorCode:r.colorCode,material:r.material,vertices:r.vertices.map(n=>n.clone()),normals:r.normals.map(()=>null),faceNormal:null})),t.conditionalSegments=e.conditionalSegments.map(r=>({colorCode:r.colorCode,material:r.material,vertices:r.vertices.map(n=>n.clone()),controlPoints:r.controlPoints.map(n=>n.clone())})),t.lineSegments=e.lineSegments.map(r=>({colorCode:r.colorCode,material:r.material,vertices:r.vertices.map(n=>n.clone())})),t.type=e.type,t.category=e.category,t.keywords=e.keywords,t.author=e.author,t.subobjects=e.subobjects,t.fileName=e.fileName,t.totalFaces=e.totalFaces,t.startingBuildingStep=e.startingBuildingStep,t.materials=e.materials,t.group=null,t}async fetchData(e){let t=!1,r=J;for(;r!==me;){let n=e;switch(r){case Pe:r=r+1;break;case J:n="parts/"+n,r=r+1;break;case Ve:n="p/"+n,r=r+1;break;case Ge:n="models/"+n,r=r+1;break;case We:n=e.substring(0,e.lastIndexOf("/")+1)+n,r=r+1;break;case Ue:t?r=me:(e=e.toLowerCase(),n=e,t=!0,r=J);break}const m=this.loader,L=new te(m.manager);L.setPath(m.partsLibraryPath),L.setRequestHeader(m.requestHeader),L.setWithCredentials(m.withCredentials);try{return await L.loadAsync(n)}catch{continue}}throw new Error('LDrawLoader: Subobject "'+e+'" could not be loaded.')}parse(e,t=null){const r=this.loader,n=[],m=[],L=[],i=[],d={},c=F=>d[F]||null;let A="Model",k=null,o=null,l=null,h=0;e.indexOf(`\r
`)!==-1&&(e=e.replace(/\r\n/g,`
`));const a=e.split(`
`),g=a.length;let u=!1,C=null,f=null,b=!1,M=!0,y=!1,T=!0,v=!1;for(let F=0;F<g;F++){const x=a[F];if(x.length===0)continue;if(u){x.startsWith("0 FILE ")?(this.setData(C,f),C=x.substring(7),f=""):f+=x+`
`;continue}const s=new Y(x,F+1);if(s.seekNonSpace(),s.isAtTheEnd())continue;const E=s.getToken();let w,p,S,D,_,N,O,G,H,re,ae;switch(E){case"0":const se=s.getToken();if(se)switch(se){case"!LDRAW_ORG":A=s.getToken();break;case"!COLOUR":w=r.parseColorMetaDirective(s),w?d[w.userData.code]=w:console.warn("LDrawLoader: Error parsing material"+s.getLineNumberString());break;case"!CATEGORY":k=s.getToken();break;case"!KEYWORDS":const ne=s.getRemainingString().split(",");ne.length>0&&(o||(o=[]),ne.forEach(function(W){o.push(W.trim())}));break;case"FILE":F>0&&(u=!0,C=s.getRemainingString(),f="",b=!1,M=!0);break;case"BFC":for(;!s.isAtTheEnd();){const W=s.getToken();switch(W){case"CERTIFY":case"NOCERTIFY":b=W==="CERTIFY",M=!0;break;case"CW":case"CCW":M=W==="CCW";break;case"INVERTNEXT":y=!0;break;case"CLIP":case"NOCLIP":T=W==="CLIP";break;default:console.warn('THREE.LDrawLoader: BFC directive "'+W+'" is unknown.');break}}break;case"STEP":v=!0;break;case"Author:":l=s.getToken();break}break;case"1":p=s.getToken(),w=c(p);const we=parseFloat(s.getToken()),ye=parseFloat(s.getToken()),Ee=parseFloat(s.getToken()),ke=parseFloat(s.getToken()),Te=parseFloat(s.getToken()),Ae=parseFloat(s.getToken()),Ie=parseFloat(s.getToken()),xe=parseFloat(s.getToken()),ve=parseFloat(s.getToken()),Fe=parseFloat(s.getToken()),Se=parseFloat(s.getToken()),De=parseFloat(s.getToken()),Ne=new Oe().set(ke,Te,Ae,we,Ie,xe,ve,ye,Fe,Se,De,Ee,0,0,0,1);let R=s.getRemainingString().trim().replace(/\\/g,"/");r.fileMap[R]?R=r.fileMap[R]:R.startsWith("s/")?R="parts/"+R:R.startsWith("48/")&&(R="p/"+R),i.push({material:w,colorCode:p,matrix:Ne,fileName:R,inverted:y,startingBuildingStep:v}),v=!1,y=!1;break;case"2":p=s.getToken(),w=c(p),N=s.getVector(),O=s.getVector(),S={material:w,colorCode:p,vertices:[N,O]},m.push(S);break;case"5":p=s.getToken(),w=c(p),N=s.getVector(),O=s.getVector(),re=s.getVector(),ae=s.getVector(),S={material:w,colorCode:p,vertices:[N,O],controlPoints:[re,ae]},L.push(S);break;case"3":p=s.getToken(),w=c(p),D=M,_=!b||!T,D===!0?(N=s.getVector(),O=s.getVector(),G=s.getVector()):(G=s.getVector(),O=s.getVector(),N=s.getVector()),n.push({material:w,colorCode:p,faceNormal:null,vertices:[N,O,G],normals:[null,null,null]}),h++,_===!0&&(n.push({material:w,colorCode:p,faceNormal:null,vertices:[G,O,N],normals:[null,null,null]}),h++);break;case"4":p=s.getToken(),w=c(p),D=M,_=!b||!T,D===!0?(N=s.getVector(),O=s.getVector(),G=s.getVector(),H=s.getVector()):(H=s.getVector(),G=s.getVector(),O=s.getVector(),N=s.getVector()),n.push({material:w,colorCode:p,faceNormal:null,vertices:[N,O,G,H],normals:[null,null,null,null]}),h+=2,_===!0&&(n.push({material:w,colorCode:p,faceNormal:null,vertices:[H,G,O,N],normals:[null,null,null,null]}),h+=2);break;default:throw new Error('LDrawLoader: Unknown line type "'+E+'"'+s.getLineNumberString()+".")}}return u&&this.setData(C,f),{faces:n,conditionalSegments:L,lineSegments:m,type:A,category:k,keywords:o,author:l,subobjects:i,totalFaces:h,startingBuildingStep:v,materials:d,fileName:t,group:null}}getData(e,t=!0){const r=e.toLowerCase(),n=this._cache[r];return n===null||n instanceof Promise?null:t?this.cloneResult(n):n}async ensureDataLoaded(e){const t=e.toLowerCase();t in this._cache||(this._cache[t]=this.fetchData(e).then(r=>{const n=this.parse(r,e);return this._cache[t]=n,n})),await this._cache[t]}setData(e,t){const r=e.toLowerCase();this._cache[r]=this.parse(t,e)}}function Q(I,e,t,r){return(!r&&I===P||r&&I===j)&&(I=e),t[I]||null}class qe{constructor(e){this.loader=e,this.parseCache=new ze(e),this._cache={}}async processIntoMesh(e){const t=this.loader,r=this.parseCache,n=new Set,m=async(i,d=null)=>{const c=i.subobjects,A=[];for(let l=0,h=c.length;l<h;l++){const a=c[l],g=r.ensureDataLoaded(a.fileName).then(()=>{const u=r.getData(a.fileName,!1);return He(u.type)?m(r.getData(a.fileName),a):this.loadModel(a.fileName).catch(C=>(console.warn(C),null))});A.push(g)}const k=new Ce;k.userData.category=i.category,k.userData.keywords=i.keywords,k.userData.author=i.author,k.userData.type=i.type,k.userData.fileName=i.fileName,i.group=k;const o=await Promise.all(A);for(let l=0,h=o.length;l<h;l++){const a=i.subobjects[l],g=o[l];if(g===null)continue;if(g.isGroup){const E=g;a.matrix.decompose(E.position,E.quaternion,E.scale),E.userData.startingBuildingStep=a.startingBuildingStep,E.name=a.fileName,t.applyMaterialsToMesh(E,a.colorCode,i.materials),E.userData.colorCode=a.colorCode,k.add(E);continue}g.group.children.length&&k.add(g.group);const u=i.lineSegments,C=i.conditionalSegments,f=i.faces,b=g.lineSegments,M=g.conditionalSegments,y=g.faces,T=a.matrix,v=a.inverted,F=T.determinant()<0,x=a.colorCode,s=x===P?j:x;for(let E=0,w=b.length;E<w;E++){const p=b[E],S=p.vertices;S[0].applyMatrix4(T),S[1].applyMatrix4(T),p.colorCode=p.colorCode===j?s:p.colorCode,p.material=p.material||Q(p.colorCode,p.colorCode,i.materials,!0),u.push(p)}for(let E=0,w=M.length;E<w;E++){const p=M[E],S=p.vertices,D=p.controlPoints;S[0].applyMatrix4(T),S[1].applyMatrix4(T),D[0].applyMatrix4(T),D[1].applyMatrix4(T),p.colorCode=p.colorCode===j?s:p.colorCode,p.material=p.material||Q(p.colorCode,p.colorCode,i.materials,!0),C.push(p)}for(let E=0,w=y.length;E<w;E++){const p=y[E],S=p.vertices;for(let D=0,_=S.length;D<_;D++)S[D].applyMatrix4(T);p.colorCode=p.colorCode===P?x:p.colorCode,p.material=p.material||Q(p.colorCode,x,i.materials,!1),n.add(p.colorCode),F!==v&&S.reverse(),f.push(p)}i.totalFaces+=g.totalFaces}return d&&(t.applyMaterialsToMesh(k,d.colorCode,i.materials),k.userData.colorCode=d.colorCode),i};for(let i=0,d=e.faces;i<d;i++)n.add(e.faces[i].colorCode);if(await m(e),t.smoothNormals){const i=n.size>1;je(e.faces),Ye(e.faces,e.lineSegments,i)}const L=e.group;return e.faces.length>0&&L.add(ee(this.loader,e.faces,3,!1,e.totalFaces)),e.lineSegments.length>0&&L.add(ee(this.loader,e.lineSegments,2)),e.conditionalSegments.length>0&&L.add(ee(this.loader,e.conditionalSegments,2,!0)),L}hasCachedModel(e){return e!==null&&e.toLowerCase()in this._cache}async getCachedModel(e){if(e!==null&&this.hasCachedModel(e)){const t=e.toLowerCase();return(await this._cache[t]).clone()}else return null}async loadModel(e){const t=this.parseCache,r=e.toLowerCase();if(this.hasCachedModel(e))return this.getCachedModel(e);{await t.ensureDataLoaded(e);const n=t.getData(e),m=this.processIntoMesh(n);return this.hasCachedModel(e)?this.getCachedModel(e):(fe(n.type)&&(this._cache[r]=m),(await m).clone())}}async parseModel(e){const r=this.parseCache.parse(e);return fe(r.type)&&this.hasCachedModel(r.fileName)?this.getCachedModel(r.fileName):this.processIntoMesh(r)}}function $e(I,e){return I.colorCode===e.colorCode?0:I.colorCode<e.colorCode?-1:1}function ee(I,e,t,r=!1,n=null){e.sort($e),n===null&&(n=e.length);const m=new Float32Array(t*n*3),L=t===3?new Float32Array(t*n*3):null,i=[],d=new Array(6),c=new Le;let A=null,k=0,o=0,l=0;for(let a=0,g=e.length;a<g;a++){const u=e[a];let C=u.vertices;C.length===4&&(d[0]=C[0],d[1]=C[1],d[2]=C[2],d[3]=C[0],d[4]=C[2],d[5]=C[3],C=d);for(let f=0,b=C.length;f<b;f++){const M=C[f],y=l+f*3;m[y+0]=M.x,m[y+1]=M.y,m[y+2]=M.z}if(t===3){if(!u.faceNormal){const b=C[0],M=C[1],y=C[2];K.subVectors(M,b),X.subVectors(y,M),u.faceNormal=new B().crossVectors(K,X).normalize()}let f=u.normals;f.length===4&&(d[0]=f[0],d[1]=f[1],d[2]=f[2],d[3]=f[0],d[4]=f[2],d[5]=f[3],f=d);for(let b=0,M=f.length;b<M;b++){let y=u.faceNormal;f[b]&&(y=f[b].norm);const T=l+b*3;L[T+0]=y.x,L[T+1]=y.y,L[T+2]=y.z}}if(A!==u.colorCode){A!==null&&c.addGroup(k,o,i.length-1);const f=u.material;if(f!==null){if(t===3)i.push(f);else if(t===2)if(r){const b=I.edgeMaterialCache.get(f);i.push(I.conditionalEdgeMaterialCache.get(b))}else i.push(I.edgeMaterialCache.get(f))}else i.push(u.colorCode);A=u.colorCode,k=l/3,o=C.length}else o+=C.length;l+=3*C.length}o>0&&c.addGroup(k,1/0,i.length-1),c.setAttribute("position",new V(m,3)),L!==null&&c.setAttribute("normal",new V(L,3));let h=null;if(t===2?r?h=new Be(c,i.length===1?i[0]:i):h=new $(c,i.length===1?i[0]:i):t===3&&(h=new be(c,i.length===1?i[0]:i)),r){h.isConditionalLine=!0;const a=new Float32Array(e.length*3*2),g=new Float32Array(e.length*3*2),u=new Float32Array(e.length*3*2);for(let C=0,f=e.length;C<f;C++){const b=e[C],M=b.vertices,y=b.controlPoints,T=y[0],v=y[1],F=M[0],x=M[1],s=C*3*2;a[s+0]=T.x,a[s+1]=T.y,a[s+2]=T.z,a[s+3]=T.x,a[s+4]=T.y,a[s+5]=T.z,g[s+0]=v.x,g[s+1]=v.y,g[s+2]=v.z,g[s+3]=v.x,g[s+4]=v.y,g[s+5]=v.z,u[s+0]=x.x-F.x,u[s+1]=x.y-F.y,u[s+2]=x.z-F.z,u[s+3]=x.x-F.x,u[s+4]=x.y-F.y,u[s+5]=x.z-F.z}c.setAttribute("control0",new V(a,3,!1)),c.setAttribute("control1",new V(g,3,!1)),c.setAttribute("direction",new V(u,3,!1))}return h}class Ze extends z{constructor(e){super(e),this.materials=[],this.materialLibrary={},this.edgeMaterialCache=new WeakMap,this.conditionalEdgeMaterialCache=new WeakMap,this.partsCache=new qe(this),this.fileMap={},this.smoothNormals=!0,this.partsLibraryPath="",this.ConditionalLineMaterial=null,this.missingColorMaterial=new U({name:z.DEFAULT_MATERIAL_NAME,color:16711935,roughness:.3,metalness:0}),this.missingEdgeColorMaterial=new oe({name:z.DEFAULT_MATERIAL_NAME,color:16711935}),this.missingConditionalEdgeColorMaterial=null,this.edgeMaterialCache.set(this.missingColorMaterial,this.missingEdgeColorMaterial),this.conditionalEdgeMaterialCache.set(this.missingEdgeColorMaterial,this.missingConditionalEdgeColorMaterial)}setPartsLibraryPath(e){return this.partsLibraryPath=e,this}setConditionalLineMaterial(e){return this.ConditionalLineMaterial=e,this.missingConditionalEdgeColorMaterial=new this.ConditionalLineMaterial({name:z.DEFAULT_MATERIAL_NAME,fog:!0,color:16711935}),this}async preloadMaterials(e){const t=new te(this.manager);t.setPath(this.path),t.setRequestHeader(this.requestHeader),t.setWithCredentials(this.withCredentials);const r=await t.loadAsync(e),n=/^0 !COLOUR/,m=r.split(/[\n\r]/g),L=[];for(let i=0,d=m.length;i<d;i++){const c=m[i];if(n.test(c)){const A=c.replace(n,""),k=this.parseColorMetaDirective(new Y(A));L.push(k)}}this.addMaterials(L)}load(e,t,r,n){const m=new te(this.manager);m.setPath(this.path),m.setRequestHeader(this.requestHeader),m.setWithCredentials(this.withCredentials),m.load(e,L=>{this.addDefaultMaterials(),this.partsCache.parseModel(L).then(i=>{this.applyMaterialsToMesh(i,P,this.materialLibrary,!0),this.computeBuildingSteps(i),i.userData.fileName=e,t(i)}).catch(n)},r,n)}parse(e,t,r){this.partsCache.parseModel(e).then(n=>{this.applyMaterialsToMesh(n,P,this.materialLibrary,!0),this.computeBuildingSteps(n),n.userData.fileName="",t(n)}).catch(r)}setMaterials(e){return this.clearMaterials(),this.addMaterials(e),this}clearMaterials(){return this.materialLibrary={},this.materials=[],this}addMaterials(e){for(let t=0,r=e.length;t<r;t++)this.addMaterial(e[t]);return this}addDefaultMaterials(){return this.addMaterial(this.parseColorMetaDirective(new Y("Main_Colour CODE 16 VALUE #FF8080 EDGE #333333"))),this.addMaterial(this.parseColorMetaDirective(new Y("Edge_Colour CODE 24 VALUE #A0A0A0 EDGE #333333"))),this}setFileMap(e){return this.fileMap=e,this}addMaterial(e){const t=this.materialLibrary;return t[e.userData.code]||(this.materials.push(e),t[e.userData.code]=e),this}getMaterial(e){if(e.startsWith("0x2")){const t=e.substring(3);return this.parseColorMetaDirective(new Y("Direct_Color_"+t+" CODE -1 VALUE #"+t+" EDGE #"+t))}return this.materialLibrary[e]||null}applyMaterialsToMesh(e,t,r,n=!1){const m=this,L=t===P;e.traverse(d=>{if(d.isMesh||d.isLineSegments)if(Array.isArray(d.material))for(let c=0,A=d.material.length;c<A;c++)d.material[c].isMaterial||(d.material[c]=i(d,d.material[c]));else d.material.isMaterial||(d.material=i(d,d.material))});function i(d,c){if(L&&!(c in r)&&!n)return c;const A=d.isLineSegments||d.isConditionalLine;(!A&&c===P||A&&c===j)&&(c=t);let o=null;if(c in r)o=r[c];else if(n)o=m.getMaterial(c),o===null&&(console.warn(`LDrawLoader: Material properties for code ${c} not available.`),o=m.missingColorMaterial);else return c;return d.isLineSegments&&(o=m.edgeMaterialCache.get(o),d.isConditionalLine&&(o=m.conditionalEdgeMaterialCache.get(o))),o}}getMainMaterial(){return this.getMaterial(P)}getMainEdgeMaterial(){const e=this.getMaterial(j);return e?this.edgeMaterialCache.get(e):null}parseColorMetaDirective(e){let t=null,r="#FF00FF",n="#FF00FF",m=1,L=!1,i=0,d=le,c=null;const A=e.getToken();if(!A)throw new Error('LDrawLoader: Material name was expected after "!COLOUR tag'+e.getLineNumberString()+".");let k=null;for(;k=e.getToken(),!!k;)if(!l(k))switch(k.toUpperCase()){case"CODE":t=e.getToken();break;case"VALUE":if(r=e.getToken(),r.startsWith("0x"))r="#"+r.substring(2);else if(!r.startsWith("#"))throw new Error("LDrawLoader: Invalid color while parsing material"+e.getLineNumberString()+".");break;case"EDGE":if(n=e.getToken(),n.startsWith("0x"))n="#"+n.substring(2);else if(!n.startsWith("#")){if(c=this.getMaterial(n),!c)throw new Error("LDrawLoader: Invalid edge color while parsing material"+e.getLineNumberString()+".");c=this.edgeMaterialCache.get(c)}break;case"ALPHA":if(m=parseInt(e.getToken()),isNaN(m))throw new Error("LDrawLoader: Invalid alpha value in material definition"+e.getLineNumberString()+".");m=Math.max(0,Math.min(1,m/255)),m<1&&(L=!0);break;case"LUMINANCE":if(!l(e.getToken()))throw new Error("LDrawLoader: Invalid luminance value in material definition"+e.getLineNumberString()+".");break;case"CHROME":d=ce;break;case"PEARLESCENT":d=he;break;case"RUBBER":d=ue;break;case"MATTE_METALLIC":d=de;break;case"METAL":d=ge;break;case"MATERIAL":e.setToEnd();break;default:throw new Error('LDrawLoader: Unknown token "'+k+'" while parsing material'+e.getLineNumberString()+".")}let o=null;switch(d){case le:o=new U({roughness:.3,metalness:0});break;case he:o=new U({roughness:.3,metalness:.25});break;case ce:o=new U({roughness:0,metalness:1});break;case ue:o=new U({roughness:.9,metalness:0});break;case de:o=new U({roughness:.8,metalness:.4});break;case ge:o=new U({roughness:.2,metalness:.85});break}if(o.color.setStyle(r,q),o.transparent=L,o.premultipliedAlpha=!0,o.opacity=m,o.depthWrite=!L,o.polygonOffset=!0,o.polygonOffsetFactor=1,i!==0&&o.emissive.setStyle(r,q).multiplyScalar(i),!c){if(c=new oe({color:new ie().setStyle(n,q),transparent:L,opacity:m,depthWrite:!L}),c.color,c.userData.code=t,c.name=A+" - Edge",this.ConditionalLineMaterial===null)throw new Error("THREE.LDrawLoader: ConditionalLineMaterial type must be specified via .setConditionalLineMaterial().");const h=new this.ConditionalLineMaterial({fog:!0,transparent:L,depthWrite:!L,color:new ie().setStyle(n,q),opacity:m});h.userData.code=t,h.name=A+" - Conditional Edge",this.conditionalEdgeMaterialCache.set(c,h)}return o.userData.code=t,o.name=A,this.edgeMaterialCache.set(o,c),this.addMaterial(o),o;function l(h){let a;return h.startsWith("LUMINANCE")?a=parseInt(h.substring(9)):a=parseInt(h),isNaN(a)?!1:(i=Math.max(0,Math.min(1,a/255)),!0)}}computeBuildingSteps(e){let t=0;e.traverse(r=>{r.isGroup&&(r.userData.startingBuildingStep&&t++,r.userData.buildingStep=t)}),e.userData.numBuildingSteps=t+1}}class Je{static mergeObject(e){function t(l,h,a,g){const u=new Le,C=l.getAttribute("position").array,f=a===3?l.getAttribute("normal").array:null,b=Math.min(h.count,Math.floor(C.length/3)-h.start),M=h.start*3,y=(h.start+b)*3,T=C.subarray(M,y),v=f!==null?f.subarray(M,y):null;if(u.setAttribute("position",new V(T,3)),v!==null&&u.setAttribute("normal",new V(v,3)),g){const F=l.getAttribute("control0").array.subarray(M,y),x=l.getAttribute("control1").array.subarray(M,y),s=l.getAttribute("direction").array.subarray(M,y);u.setAttribute("control0",new V(F,3,!1)),u.setAttribute("control1",new V(x,3,!1)),u.setAttribute("direction",new V(s,3,!1))}return u}function r(l,h,a){const g=a[l.uuid];g?g.arr.push(h):a[l.uuid]={mat:l,arr:[h]}}function n(l,h){if(!l)return;const a=l.array,g=Math.floor(a.length/3);let u=0;for(let C=0;C<g;C++){const f=a[u],b=a[u+1],M=a[u+2];a[u]=a[u+3],a[u+1]=a[u+4],a[u+2]=a[u+5],a[u+3]=f,a[u+4]=b,a[u+5]=M,u+=h*3}}const m={},L={},i={};e.updateMatrixWorld(!0);const d=new Re;e.traverse(l=>{if(l.isMesh|l.isLineSegments){const h=l.isMesh?3:2,a=l.geometry.clone();l.matrixWorld.determinant()<0&&(n(a.attributes.position,h),n(a.attributes.normal,h)),a.applyMatrix4(l.matrixWorld),l.isConditionalLine&&(a.attributes.control0.applyMatrix4(l.matrixWorld),a.attributes.control1.applyMatrix4(l.matrixWorld),d.getNormalMatrix(l.matrixWorld),a.attributes.direction.applyNormalMatrix(d));const u=l.isMesh?m:l.isConditionalLine?i:L;if(Array.isArray(l.material))for(const C in a.groups){const f=a.groups[C],b=l.material[f.materialIndex],M=t(a,f,h,l.isConditionalLine);r(b,M,u)}else r(l.material,a,u)}});const c=new Ce,A=Object.keys(m);for(const l of A){const h=m[l],a=Z(h.arr);c.add(new be(a,h.mat))}const k=Object.keys(L);for(const l of k){const h=L[l],a=Z(h.arr);c.add(new $(a,h.mat))}const o=Object.keys(i);for(const l of o){const h=i[l],a=Z(h.arr),g=new $(a,h.mat);g.isConditionalLine=!0,c.add(g)}return c.userData.constructionStep=0,c.userData.numConstructionSteps=1,c}}export{Ze as L,Je as a};
