import{c as Jn,q as Yn,e as Tt,f as Xn,g as Zn,m as me,l as de,G as At,av as Pt,T as Qn,C as Ct,a2 as Le,a5 as Et,aB as $n,aC as vt,ae as He,i as pe,V as eo,A as Gt,af as to,a1 as Qe,a3 as Ot,aD as no,S as oo,j as so,k as ao,a0 as xt,Q as io,ab as Lt,ad as ro,K as co,aE as ge,a6 as lo,z as Mt,U as uo,X as qt,Z as ho,Y as fo,a4 as mo,u as Fe,w as St,at as po,au as Bt,aF as go,M as Ht,E as bo,ah as yo,ai as ko,aG as wo,h as _o,aH as No}from"./MaterialBase-byhyp4gt.js";import{M as To}from"./meshopt_decoder.module-j6OW_3Rk.js";import{H as Ao}from"./HDRLoader-uXUM045B.js";import{G as Co}from"./GLTFLoader-BYq4k_JA.js";import{L as Eo,a as vo}from"./LDrawUtils-D5m1mivQ.js";import{g as xo}from"./lil-gui.module.min-BH_YJbPT.js";import{S as Lo}from"./stats.module--VATS4Kh.js";import{g as Mo}from"./__vite-browser-external-C8XJ56jx.js";import{O as So}from"./OrbitControls-BDTesZS8.js";import{g as Io}from"./getScaledSettings-nzgggDDj.js";import{L as jo}from"./LoaderElement-kg8-0xPv.js";import{P as Ro}from"./ParallelMeshBVHWorker-DmJoIDz8.js";import{W as Po,G as Go}from"./WebGLPathTracer-DzRjmE4y.js";class It extends Jn{constructor(x){super(x)}parse(x){function L(m){switch(m.image_type){case Se:case $:if(m.colormap_length>256||m.colormap_size!==24||m.colormap_type!==1)throw new Error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case Y:case te:case Ee:case Ie:if(m.colormap_type)throw new Error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case Ve:throw new Error("THREE.TGALoader: No data.");default:throw new Error("THREE.TGALoader: Invalid type "+m.image_type)}if(m.width<=0||m.height<=0)throw new Error("THREE.TGALoader: Invalid image size.");if(m.pixel_size!==8&&m.pixel_size!==16&&m.pixel_size!==24&&m.pixel_size!==32)throw new Error("THREE.TGALoader: Invalid pixel size "+m.pixel_size)}function f(m,V,B,G,D){let j,O;const v=B.pixel_size>>3,E=B.width*B.height*v;if(V&&(O=D.subarray(G,G+=B.colormap_length*(B.colormap_size>>3))),m){j=new Uint8Array(E);let N,u,T,H=0;const oe=new Uint8Array(v);for(;H<E;)if(N=D[G++],u=(N&127)+1,N&128){for(T=0;T<v;++T)oe[T]=D[G++];for(T=0;T<u;++T)j.set(oe,H+T*v);H+=v*u}else{for(u*=v,T=0;T<u;++T)j[H+T]=D[G++];H+=u}}else j=D.subarray(G,G+=V?B.width*B.height:E);return{pixel_data:j,palettes:O}}function C(m,V,B,G,D,j,O,v,E){const N=E;let u,T=0,H,oe;const _e=z.width;for(oe=V;oe!==G;oe+=B)for(H=D;H!==O;H+=j,T++)u=v[T],m[(H+_e*oe)*4+3]=255,m[(H+_e*oe)*4+2]=N[u*3+0],m[(H+_e*oe)*4+1]=N[u*3+1],m[(H+_e*oe)*4+0]=N[u*3+2];return m}function g(m,V,B,G,D,j,O,v){let E,N=0,u,T;const H=z.width;for(T=V;T!==G;T+=B)for(u=D;u!==O;u+=j,N+=2)E=v[N+0]+(v[N+1]<<8),m[(u+H*T)*4+0]=(E&31744)>>7,m[(u+H*T)*4+1]=(E&992)>>2,m[(u+H*T)*4+2]=(E&31)<<3,m[(u+H*T)*4+3]=E&32768?0:255;return m}function M(m,V,B,G,D,j,O,v){let E=0,N,u;const T=z.width;for(u=V;u!==G;u+=B)for(N=D;N!==O;N+=j,E+=3)m[(N+T*u)*4+3]=255,m[(N+T*u)*4+2]=v[E+0],m[(N+T*u)*4+1]=v[E+1],m[(N+T*u)*4+0]=v[E+2];return m}function P(m,V,B,G,D,j,O,v){let E=0,N,u;const T=z.width;for(u=V;u!==G;u+=B)for(N=D;N!==O;N+=j,E+=4)m[(N+T*u)*4+2]=v[E+0],m[(N+T*u)*4+1]=v[E+1],m[(N+T*u)*4+0]=v[E+2],m[(N+T*u)*4+3]=v[E+3];return m}function Q(m,V,B,G,D,j,O,v){let E,N=0,u,T;const H=z.width;for(T=V;T!==G;T+=B)for(u=D;u!==O;u+=j,N++)E=v[N],m[(u+H*T)*4+0]=E,m[(u+H*T)*4+1]=E,m[(u+H*T)*4+2]=E,m[(u+H*T)*4+3]=255;return m}function re(m,V,B,G,D,j,O,v){let E=0,N,u;const T=z.width;for(u=V;u!==G;u+=B)for(N=D;N!==O;N+=j,E+=2)m[(N+T*u)*4+0]=v[E+0],m[(N+T*u)*4+1]=v[E+0],m[(N+T*u)*4+2]=v[E+0],m[(N+T*u)*4+3]=v[E+1];return m}function Ce(m,V,B,G,D){let j,O,v,E,N,u;switch((z.flags&We)>>je){default:case Ke:j=0,v=1,N=V,O=0,E=1,u=B;break;case Re:j=0,v=1,N=V,O=B-1,E=-1,u=-1;break;case ke:j=V-1,v=-1,N=-1,O=0,E=1,u=B;break;case De:j=V-1,v=-1,N=-1,O=B-1,E=-1,u=-1;break}if(xe)switch(z.pixel_size){case 8:Q(m,O,E,u,j,v,N,G);break;case 16:re(m,O,E,u,j,v,N,G);break;default:throw new Error("THREE.TGALoader: Format not supported.")}else switch(z.pixel_size){case 8:C(m,O,E,u,j,v,N,G,D);break;case 16:g(m,O,E,u,j,v,N,G);break;case 24:M(m,O,E,u,j,v,N,G);break;case 32:P(m,O,E,u,j,v,N,G);break;default:throw new Error("THREE.TGALoader: Format not supported.")}return m}const Ve=0,Se=1,Y=2,te=3,$=9,Ee=10,Ie=11,We=48,je=4,Re=0,De=1,Ke=2,ke=3;if(x.length<19)throw new Error("THREE.TGALoader: Not enough data to contain header.");let q=0;const F=new Uint8Array(x),z={id_length:F[q++],colormap_type:F[q++],image_type:F[q++],colormap_index:F[q++]|F[q++]<<8,colormap_length:F[q++]|F[q++]<<8,colormap_size:F[q++],origin:[F[q++]|F[q++]<<8,F[q++]|F[q++]<<8],width:F[q++]|F[q++]<<8,height:F[q++]|F[q++]<<8,pixel_size:F[q++],flags:F[q++]};if(L(z),z.id_length+q>x.length)throw new Error("THREE.TGALoader: No data.");q+=z.id_length;let we=!1,ve=!1,xe=!1;switch(z.image_type){case $:we=!0,ve=!0;break;case Se:ve=!0;break;case Ee:we=!0;break;case Y:break;case Ie:we=!0,xe=!0;break;case te:xe=!0;break}const Pe=new Uint8Array(z.width*z.height*4),Ge=f(we,ve,z,q,F);return Ce(Pe,z.width,z.height,Ge.pixel_data,Ge.palettes),{data:Pe,width:z.width,height:z.height,flipY:!0,generateMipmaps:!0,minFilter:Yn}}}class Oo extends Tt{load(x,L,f,C){const g=this,M=g.path===""?Xn.extractUrlBase(x):g.path,P=new Zn(g.manager);P.setPath(g.path),P.setRequestHeader(g.requestHeader),P.setWithCredentials(g.withCredentials),P.load(x,function(Q){try{L(g.parse(Q,M))}catch(re){C?C(re):console.error(re),g.manager.itemError(x)}},f,C)}parse(x,L){function f(t,e){const o=[],n=t.childNodes;for(let s=0,a=n.length;s<a;s++){const i=n[s];i.nodeName===e&&o.push(i)}return o}function C(t){if(t.length===0)return[];const e=t.trim().split(/\s+/),o=new Array(e.length);for(let n=0,s=e.length;n<s;n++)o[n]=e[n];return o}function g(t){if(t.length===0)return[];const e=t.trim().split(/\s+/),o=new Array(e.length);for(let n=0,s=e.length;n<s;n++)o[n]=parseFloat(e[n]);return o}function M(t){if(t.length===0)return[];const e=t.trim().split(/\s+/),o=new Array(e.length);for(let n=0,s=e.length;n<s;n++)o[n]=parseInt(e[n]);return o}function P(t){return t.substring(1)}function Q(){return"three_default_"+Dn++}function re(t){return Object.keys(t).length===0}function Ce(t){return{unit:Ve(f(t,"unit")[0]),upAxis:Se(f(t,"up_axis")[0])}}function Ve(t){return t!==void 0&&t.hasAttribute("meter")===!0?parseFloat(t.getAttribute("meter")):1}function Se(t){return t!==void 0?t.textContent:"Y_UP"}function Y(t,e,o,n){const s=f(t,e)[0];if(s!==void 0){const a=f(s,o);for(let i=0;i<a.length;i++)n(a[i])}}function te(t,e){for(const o in t){const n=t[o];n.build=e(t[o])}}function $(t,e){return t.build!==void 0||(t.build=e(t)),t.build}function Ee(t){const e={sources:{},samplers:{},channels:{}};let o=!1;for(let n=0,s=t.childNodes.length;n<s;n++){const a=t.childNodes[n];if(a.nodeType!==1)continue;let i;switch(a.nodeName){case"source":i=a.getAttribute("id"),e.sources[i]=Je(a);break;case"sampler":i=a.getAttribute("id"),e.samplers[i]=Ie(a);break;case"channel":i=a.getAttribute("target"),e.channels[i]=We(a);break;case"animation":Ee(a),o=!0;break;default:console.log(a)}}o===!1&&(A.animations[t.getAttribute("id")||Le.generateUUID()]=e)}function Ie(t){const e={inputs:{}};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"input":const a=P(s.getAttribute("source")),i=s.getAttribute("semantic");e.inputs[i]=a;break}}return e}function We(t){const e={};let n=t.getAttribute("target").split("/");const s=n.shift();let a=n.shift();const i=a.indexOf("(")!==-1,d=a.indexOf(".")!==-1;if(d)n=a.split("."),a=n.shift(),e.member=n.shift();else if(i){const c=a.split("(");a=c.shift();for(let l=0;l<c.length;l++)c[l]=parseInt(c[l].replace(/\)/,""));e.indices=c}return e.id=s,e.sid=a,e.arraySyntax=i,e.memberSyntax=d,e.sampler=P(t.getAttribute("source")),e}function je(t){const e=[],o=t.channels,n=t.samplers,s=t.sources;for(const a in o)if(o.hasOwnProperty(a)){const i=o[a],d=n[i.sampler],c=d.inputs.INPUT,l=d.inputs.OUTPUT,b=s[c],r=s[l],p=De(i,b,r);z(p,e)}return e}function Re(t){return $(A.animations[t],je)}function De(t,e,o){const n=A.nodes[t.id],s=Te(n.id),a=n.transforms[t.sid],i=n.matrix.clone().transpose();let d,c,l,b,r,p;const h={};switch(a){case"matrix":for(l=0,b=e.array.length;l<b;l++)if(d=e.array[l],c=l*o.stride,h[d]===void 0&&(h[d]={}),t.arraySyntax===!0){const U=o.array[c],R=t.indices[0]+4*t.indices[1];h[d][R]=U}else for(r=0,p=o.stride;r<p;r++)h[d][r]=o.array[c+r];break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',a);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',a);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',a);break}const _=Ke(h,i);return{name:s.uuid,keyframes:_}}function Ke(t,e){const o=[];for(const s in t)o.push({time:parseFloat(s),value:t[s]});o.sort(n);for(let s=0;s<16;s++)we(o,s,e.elements[s]);return o;function n(s,a){return s.time-a.time}}const ke=new me,q=new me,F=new io;function z(t,e){const o=t.keyframes,n=t.name,s=[],a=[],i=[],d=[];for(let c=0,l=o.length;c<l;c++){const b=o[c],r=b.time,p=b.value;ne.fromArray(p).transpose(),ne.decompose(ke,F,q),s.push(r),a.push(ke.x,ke.y,ke.z),i.push(F.x,F.y,F.z,F.w),d.push(q.x,q.y,q.z)}return a.length>0&&e.push(new Lt(n+".position",s,a)),i.length>0&&e.push(new ro(n+".quaternion",s,i)),d.length>0&&e.push(new Lt(n+".scale",s,d)),e}function we(t,e,o){let n,s=!0,a,i;for(a=0,i=t.length;a<i;a++)n=t[a],n.value[e]===void 0?n.value[e]=null:s=!1;if(s===!0)for(a=0,i=t.length;a<i;a++)n=t[a],n.value[e]=o;else ve(t,e)}function ve(t,e){let o,n;for(let s=0,a=t.length;s<a;s++){const i=t[s];if(i.value[e]===null){if(o=xe(t,s,e),n=Pe(t,s,e),o===null){i.value[e]=n.value[e];continue}if(n===null){i.value[e]=o.value[e];continue}Ge(i,o,n,e)}}}function xe(t,e,o){for(;e>=0;){const n=t[e];if(n.value[o]!==null)return n;e--}return null}function Pe(t,e,o){for(;e<t.length;){const n=t[e];if(n.value[o]!==null)return n;e++}return null}function Ge(t,e,o,n){if(o.time-e.time===0){t.value[n]=e.value[n];return}t.value[n]=(t.time-e.time)*(o.value[n]-e.value[n])/(o.time-e.time)+e.value[n]}function m(t){const e={name:t.getAttribute("id")||"default",start:parseFloat(t.getAttribute("start")||0),end:parseFloat(t.getAttribute("end")||0),animations:[]};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"instance_animation":e.animations.push(P(s.getAttribute("url")));break}}A.clips[t.getAttribute("id")]=e}function V(t){const e=[],o=t.name,n=t.end-t.start||-1,s=t.animations;for(let a=0,i=s.length;a<i;a++){const d=Re(s[a]);for(let c=0,l=d.length;c<l;c++)e.push(d[c])}return new Et(o,n,e)}function B(t){return $(A.clips[t],V)}function G(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"skin":e.id=P(s.getAttribute("source")),e.skin=D(s);break;case"morph":e.id=P(s.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}A.controllers[t.getAttribute("id")]=e}function D(t){const e={sources:{}};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"bind_shape_matrix":e.bindShapeMatrix=g(s.textContent);break;case"source":const a=s.getAttribute("id");e.sources[a]=Je(s);break;case"joints":e.joints=j(s);break;case"vertex_weights":e.vertexWeights=O(s);break}}return e}function j(t){const e={inputs:{}};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"input":const a=s.getAttribute("semantic"),i=P(s.getAttribute("source"));e.inputs[a]=i;break}}return e}function O(t){const e={inputs:{}};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"input":const a=s.getAttribute("semantic"),i=P(s.getAttribute("source")),d=parseInt(s.getAttribute("offset"));e.inputs[a]={id:i,offset:d};break;case"vcount":e.vcount=M(s.textContent);break;case"v":e.v=M(s.textContent);break}}return e}function v(t){const e={id:t.id},o=A.geometries[e.id];return t.skin!==void 0&&(e.skin=E(t.skin),o.sources.skinIndices=e.skin.indices,o.sources.skinWeights=e.skin.weights),e}function E(t){const o={joints:[],indices:{array:[],stride:4},weights:{array:[],stride:4}},n=t.sources,s=t.vertexWeights,a=s.vcount,i=s.v,d=s.inputs.JOINT.offset,c=s.inputs.WEIGHT.offset,l=t.sources[t.joints.inputs.JOINT],b=t.sources[t.joints.inputs.INV_BIND_MATRIX],r=n[s.inputs.WEIGHT.id].array;let p=0,h,_,k;for(h=0,k=a.length;h<k;h++){const R=a[h],S=[];for(_=0;_<R;_++){const I=i[p+d],le=i[p+c],ee=r[le];S.push({index:I,weight:ee}),p+=2}for(S.sort(U),_=0;_<4;_++){const I=S[_];I!==void 0?(o.indices.array.push(I.index),o.weights.array.push(I.weight)):(o.indices.array.push(0),o.weights.array.push(0))}}for(t.bindShapeMatrix?o.bindMatrix=new de().fromArray(t.bindShapeMatrix).transpose():o.bindMatrix=new de().identity(),h=0,k=l.array.length;h<k;h++){const R=l.array[h],S=new de().fromArray(b.array,h*b.stride).transpose();o.joints.push({name:R,boneInverse:S})}return o;function U(R,S){return S.weight-R.weight}}function N(t){return $(A.controllers[t],v)}function u(t){const e={init_from:f(t,"init_from")[0].textContent};A.images[t.getAttribute("id")]=e}function T(t){return t.build!==void 0?t.build:t.init_from}function H(t){const e=A.images[t];return e!==void 0?$(e,T):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",t),null)}function oe(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"profile_COMMON":e.profile=_e(s);break}}A.effects[t.getAttribute("id")]=e}function _e(t){const e={surfaces:{},samplers:{}};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"newparam":Wt(s,e);break;case"technique":e.technique=Jt(s);break;case"extra":e.extra=nt(s);break}}return e}function Wt(t,e){const o=t.getAttribute("sid");for(let n=0,s=t.childNodes.length;n<s;n++){const a=t.childNodes[n];if(a.nodeType===1)switch(a.nodeName){case"surface":e.surfaces[o]=Dt(a);break;case"sampler2D":e.samplers[o]=Kt(a);break}}}function Dt(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"init_from":e.init_from=s.textContent;break}}return e}function Kt(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"source":e.source=s.textContent;break}}return e}function Jt(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"constant":case"lambert":case"blinn":case"phong":e.type=s.nodeName,e.parameters=Yt(s);break;case"extra":e.extra=nt(s);break}}return e}function Yt(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":e[s.nodeName]=et(s);break;case"transparent":e[s.nodeName]={opaque:s.hasAttribute("opaque")?s.getAttribute("opaque"):"A_ONE",data:et(s)};break}}return e}function et(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"color":e[s.nodeName]=g(s.textContent);break;case"float":e[s.nodeName]=parseFloat(s.textContent);break;case"texture":e[s.nodeName]={id:s.getAttribute("texture"),extra:tt(s)};break}}return e}function tt(t){const e={technique:{}};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"extra":Xt(s,e);break}}return e}function Xt(t,e){for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"technique":Zt(s,e);break}}}function Zt(t,e){for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":e.technique[s.nodeName]=parseFloat(s.textContent);break;case"wrapU":case"wrapV":s.textContent.toUpperCase()==="TRUE"?e.technique[s.nodeName]=1:s.textContent.toUpperCase()==="FALSE"?e.technique[s.nodeName]=0:e.technique[s.nodeName]=parseInt(s.textContent);break;case"bump":e[s.nodeName]=ot(s);break}}}function nt(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"technique":e.technique=Qt(s);break}}return e}function Qt(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"double_sided":e[s.nodeName]=parseInt(s.textContent);break;case"bump":e[s.nodeName]=ot(s);break}}return e}function ot(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"texture":e[s.nodeName]={id:s.getAttribute("texture"),texcoord:s.getAttribute("texcoord"),extra:tt(s)};break}}return e}function st(t){return t}function $t(t){return $(A.effects[t],st)}function en(t){const e={name:t.getAttribute("name")};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"instance_effect":e.url=P(s.getAttribute("url"));break}}A.materials[t.getAttribute("id")]=e}function tn(t){let e,o=t.slice((t.lastIndexOf(".")-1>>>0)+2);switch(o=o.toLowerCase(),o){case"tga":e=Ze;break;default:e=wt}return e}function at(t){const e=$t(t.url),o=e.profile.technique;let n;switch(o.type){case"phong":case"blinn":n=new vt;break;case"lambert":n=new $n;break;default:n=new At;break}n.name=t.name||"";function s(c,l=null){const b=e.profile.samplers[c.id];let r=null;if(b!==void 0){const p=e.profile.surfaces[b.source];r=H(p.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),r=H(c.id);if(r!==null){const p=tn(r);if(p!==void 0){const h=p.load(r),_=c.extra;if(_!==void 0&&_.technique!==void 0&&re(_.technique)===!1){const k=_.technique;h.wrapS=k.wrapU?Fe:St,h.wrapT=k.wrapV?Fe:St,h.offset.set(k.offsetU||0,k.offsetV||0),h.repeat.set(k.repeatU||1,k.repeatV||1)}else h.wrapS=Fe,h.wrapT=Fe;return l!==null&&(h.colorSpace=l),h}else return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",r),null}else return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",c.id),null}const a=o.parameters;for(const c in a){const l=a[c];switch(c){case"diffuse":l.color&&n.color.fromArray(l.color),l.texture&&(n.map=s(l.texture,pe));break;case"specular":l.color&&n.specular&&n.specular.fromArray(l.color),l.texture&&(n.specularMap=s(l.texture));break;case"bump":l.texture&&(n.normalMap=s(l.texture));break;case"ambient":l.texture&&(n.lightMap=s(l.texture,pe));break;case"shininess":l.float&&n.shininess&&(n.shininess=l.float);break;case"emission":l.color&&n.emissive&&n.emissive.fromArray(l.color),l.texture&&(n.emissiveMap=s(l.texture,pe));break}}He.colorSpaceToWorking(n.color,pe),n.specular&&He.colorSpaceToWorking(n.specular,pe),n.emissive&&He.colorSpaceToWorking(n.emissive,pe);let i=a.transparent,d=a.transparency;if(d===void 0&&i&&(d={float:1}),i===void 0&&d&&(i={opaque:"A_ONE",data:{color:[1,1,1,1]}}),i&&d)if(i.data.texture)n.transparent=!0;else{const c=i.data.color;switch(i.opaque){case"A_ONE":n.opacity=c[3]*d.float;break;case"RGB_ZERO":n.opacity=1-c[0]*d.float;break;case"A_ZERO":n.opacity=1-c[3]*d.float;break;case"RGB_ONE":n.opacity=c[0]*d.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',i.opaque)}n.opacity<1&&(n.transparent=!0)}if(o.extra!==void 0&&o.extra.technique!==void 0){const c=o.extra.technique;for(const l in c){const b=c[l];switch(l){case"double_sided":n.side=b===1?Gt:to;break;case"bump":n.normalMap=s(b.texture),n.normalScale=new eo(1,1);break}}}return n}function nn(t){return $(A.materials[t],at)}function on(t){const e={name:t.getAttribute("name")};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"optics":e.optics=sn(s);break}}A.cameras[t.getAttribute("id")]=e}function sn(t){for(let e=0;e<t.childNodes.length;e++){const o=t.childNodes[e];switch(o.nodeName){case"technique_common":return an(o)}}return{}}function an(t){const e={};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];switch(n.nodeName){case"perspective":case"orthographic":e.technique=n.nodeName,e.parameters=rn(n);break}}return e}function rn(t){const e={};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];switch(n.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":e[n.nodeName]=parseFloat(n.textContent);break}}return e}function it(t){let e;switch(t.optics.technique){case"perspective":e=new Qe(t.optics.parameters.yfov,t.optics.parameters.aspect_ratio,t.optics.parameters.znear,t.optics.parameters.zfar);break;case"orthographic":let o=t.optics.parameters.ymag,n=t.optics.parameters.xmag;const s=t.optics.parameters.aspect_ratio;n=n===void 0?o*s:n,o=o===void 0?n/s:o,n*=.5,o*=.5,e=new Ot(-n,n,o,-o,t.optics.parameters.znear,t.optics.parameters.zfar);break;default:e=new Qe;break}return e.name=t.name||"",e}function cn(t){const e=A.cameras[t];return e!==void 0?$(e,it):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",t),null)}function ln(t){let e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"technique_common":e=dn(s);break}}A.lights[t.getAttribute("id")]=e}function dn(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"directional":case"point":case"spot":case"ambient":e.technique=s.nodeName,e.parameters=un(s)}}return e}function un(t){const e={};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"color":const a=g(s.textContent);e.color=new Ct().fromArray(a),He.colorSpaceToWorking(e.color,pe);break;case"falloff_angle":e.falloffAngle=parseFloat(s.textContent);break;case"quadratic_attenuation":const i=parseFloat(s.textContent);e.distance=i?Math.sqrt(1/i):0;break}}return e}function rt(t){let e;switch(t.technique){case"directional":e=new ao;break;case"point":e=new so;break;case"spot":e=new oo;break;case"ambient":e=new no;break}return t.parameters.color&&e.color.copy(t.parameters.color),t.parameters.distance&&(e.distance=t.parameters.distance),e}function hn(t){const e=A.lights[t];return e!==void 0?$(e,rt):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",t),null)}function fn(t){const e={name:t.getAttribute("name"),sources:{},vertices:{},primitives:[]},o=f(t,"mesh")[0];if(o!==void 0){for(let n=0;n<o.childNodes.length;n++){const s=o.childNodes[n];if(s.nodeType!==1)continue;const a=s.getAttribute("id");switch(s.nodeName){case"source":e.sources[a]=Je(s);break;case"vertices":e.vertices=mn(s);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",s.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":e.primitives.push(pn(s));break;default:console.log(s)}}A.geometries[t.getAttribute("id")]=e}}function Je(t){const e={array:[],stride:3};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"float_array":e.array=g(n.textContent);break;case"Name_array":e.array=C(n.textContent);break;case"technique_common":const s=f(n,"accessor")[0];s!==void 0&&(e.stride=parseInt(s.getAttribute("stride")));break}}return e}function mn(t){const e={};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];n.nodeType===1&&(e[n.getAttribute("semantic")]=P(n.getAttribute("source")))}return e}function pn(t){const e={type:t.nodeName,material:t.getAttribute("material"),count:parseInt(t.getAttribute("count")),inputs:{},stride:0,hasUV:!1};for(let o=0,n=t.childNodes.length;o<n;o++){const s=t.childNodes[o];if(s.nodeType===1)switch(s.nodeName){case"input":const a=P(s.getAttribute("source")),i=s.getAttribute("semantic"),d=parseInt(s.getAttribute("offset")),c=parseInt(s.getAttribute("set")),l=c>0?i+c:i;e.inputs[l]={id:a,offset:d},e.stride=Math.max(e.stride,d+1),i==="TEXCOORD"&&(e.hasUV=!0);break;case"vcount":e.vcount=M(s.textContent);break;case"p":e.p=M(s.textContent);break}}return e}function gn(t){const e={};for(let o=0;o<t.length;o++){const n=t[o];e[n.type]===void 0&&(e[n.type]=[]),e[n.type].push(n)}return e}function bn(t){let e=0;for(let o=0,n=t.length;o<n;o++)t[o].hasUV===!0&&e++;e>0&&e<t.length&&(t.uvsNeedsFix=!0)}function ct(t){const e={},o=t.sources,n=t.vertices,s=t.primitives;if(s.length===0)return{};const a=gn(s);for(const i in a){const d=a[i];bn(d),e[i]=yn(d,o,n)}return e}function yn(t,e,o){const n={},s={array:[],stride:0},a={array:[],stride:0},i={array:[],stride:0},d={array:[],stride:0},c={array:[],stride:0},l={array:[],stride:4},b={array:[],stride:4},r=new co,p=[];let h=0;for(let _=0;_<t.length;_++){const k=t[_],U=k.inputs;let R=0;switch(k.type){case"lines":case"linestrips":R=k.count*2;break;case"triangles":R=k.count*3;break;case"polylist":for(let S=0;S<k.count;S++){const I=k.vcount[S];switch(I){case 3:R+=3;break;case 4:R+=6;break;default:R+=(I-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknown primitive type:",k.type)}r.addGroup(h,R,_),h+=R,k.material&&p.push(k.material);for(const S in U){const I=U[S];switch(S){case"VERTEX":for(const le in o){const ee=o[le];switch(le){case"POSITION":const Ae=s.array.length;if(ae(k,e[ee],I.offset,s.array),s.stride=e[ee].stride,e.skinWeights&&e.skinIndices&&(ae(k,e.skinIndices,I.offset,l.array),ae(k,e.skinWeights,I.offset,b.array)),k.hasUV===!1&&t.uvsNeedsFix===!0){const Kn=(s.array.length-Ae)/s.stride;for(let Nt=0;Nt<Kn;Nt++)i.array.push(0,0)}break;case"NORMAL":ae(k,e[ee],I.offset,a.array),a.stride=e[ee].stride;break;case"COLOR":ae(k,e[ee],I.offset,c.array),c.stride=e[ee].stride;break;case"TEXCOORD":ae(k,e[ee],I.offset,i.array),i.stride=e[ee].stride;break;case"TEXCOORD1":ae(k,e[ee],I.offset,d.array),i.stride=e[ee].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',le)}}break;case"NORMAL":ae(k,e[I.id],I.offset,a.array),a.stride=e[I.id].stride;break;case"COLOR":ae(k,e[I.id],I.offset,c.array,!0),c.stride=e[I.id].stride;break;case"TEXCOORD":ae(k,e[I.id],I.offset,i.array),i.stride=e[I.id].stride;break;case"TEXCOORD1":ae(k,e[I.id],I.offset,d.array),d.stride=e[I.id].stride;break}}}return s.array.length>0&&r.setAttribute("position",new ge(s.array,s.stride)),a.array.length>0&&r.setAttribute("normal",new ge(a.array,a.stride)),c.array.length>0&&r.setAttribute("color",new ge(c.array,c.stride)),i.array.length>0&&r.setAttribute("uv",new ge(i.array,i.stride)),d.array.length>0&&r.setAttribute("uv1",new ge(d.array,d.stride)),l.array.length>0&&r.setAttribute("skinIndex",new ge(l.array,l.stride)),b.array.length>0&&r.setAttribute("skinWeight",new ge(b.array,b.stride)),n.data=r,n.type=t[0].type,n.materialKeys=p,n}function ae(t,e,o,n,s=!1){const a=t.p,i=t.stride,d=t.vcount;function c(r){let p=a[r+o]*b;const h=p+b;for(;p<h;p++)n.push(l[p]);if(s){const _=n.length-b-1;Oe.setRGB(n[_+0],n[_+1],n[_+2],pe),n[_+0]=Oe.r,n[_+1]=Oe.g,n[_+2]=Oe.b}}const l=e.array,b=e.stride;if(t.vcount!==void 0){let r=0;for(let p=0,h=d.length;p<h;p++){const _=d[p];if(_===4){const k=r+i*0,U=r+i*1,R=r+i*2,S=r+i*3;c(k),c(U),c(S),c(U),c(R),c(S)}else if(_===3){const k=r+i*0,U=r+i*1,R=r+i*2;c(k),c(U),c(R)}else if(_>4)for(let k=1,U=_-2;k<=U;k++){const R=r+i*0,S=r+i*k,I=r+i*(k+1);c(R),c(S),c(I)}r+=i*_}}else for(let r=0,p=a.length;r<p;r+=i)c(r)}function lt(t){return $(A.geometries[t],ct)}function kn(t){const e={name:t.getAttribute("name")||"",joints:{},links:[]};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"technique_common":Nn(n,e);break}}A.kinematicsModels[t.getAttribute("id")]=e}function wn(t){return t.build!==void 0?t.build:t}function _n(t){return $(A.kinematicsModels[t],wn)}function Nn(t,e){for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"joint":e.joints[n.getAttribute("sid")]=Tn(n);break;case"link":e.links.push(dt(n));break}}}function Tn(t){let e;for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"prismatic":case"revolute":e=An(n);break}}return e}function An(t){const e={sid:t.getAttribute("sid"),name:t.getAttribute("name")||"",axis:new me,limits:{min:0,max:0},type:t.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"axis":const s=g(n.textContent);e.axis.fromArray(s);break;case"limits":const a=n.getElementsByTagName("max")[0],i=n.getElementsByTagName("min")[0];e.limits.max=parseFloat(a.textContent),e.limits.min=parseFloat(i.textContent);break}}return e.limits.min>=e.limits.max&&(e.static=!0),e.middlePosition=(e.limits.min+e.limits.max)/2,e}function dt(t){const e={sid:t.getAttribute("sid"),name:t.getAttribute("name")||"",attachments:[],transforms:[]};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"attachment_full":e.attachments.push(Cn(n));break;case"matrix":case"translate":case"rotate":e.transforms.push(ut(n));break}}return e}function Cn(t){const e={joint:t.getAttribute("joint").split("/").pop(),transforms:[],links:[]};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"link":e.links.push(dt(n));break;case"matrix":case"translate":case"rotate":e.transforms.push(ut(n));break}}return e}function ut(t){const e={type:t.nodeName},o=g(t.textContent);switch(e.type){case"matrix":e.obj=new de,e.obj.fromArray(o).transpose();break;case"translate":e.obj=new me,e.obj.fromArray(o);break;case"rotate":e.obj=new me,e.obj.fromArray(o),e.angle=Le.degToRad(o[3]);break}return e}function En(t){const e={name:t.getAttribute("name")||"",rigidBodies:{}};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"rigid_body":e.rigidBodies[n.getAttribute("name")]={},vn(n,e.rigidBodies[n.getAttribute("name")]);break}}A.physicsModels[t.getAttribute("id")]=e}function vn(t,e){for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"technique_common":xn(n,e);break}}}function xn(t,e){for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"inertia":e.inertia=g(n.textContent);break;case"mass":e.mass=g(n.textContent)[0];break}}}function Ln(t){const e={bindJointAxis:[]};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"bind_joint_axis":e.bindJointAxis.push(Mn(n));break}}A.kinematicsScenes[P(t.getAttribute("url"))]=e}function Mn(t){const e={target:t.getAttribute("target").split("/").pop()};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType===1)switch(n.nodeName){case"axis":const s=n.getElementsByTagName("param")[0];e.axis=s.textContent;const a=e.axis.split("inst_").pop().split("axis")[0];e.jointIndex=a.substring(0,a.length-1);break}}return e}function Sn(t){return t.build!==void 0?t.build:t}function In(t){return $(A.kinematicsScenes[t],Sn)}function jn(){const t=Object.keys(A.kinematicsModels)[0],e=Object.keys(A.kinematicsScenes)[0],o=Object.keys(A.visualScenes)[0];if(t===void 0||e===void 0)return;const n=_n(t),s=In(e),a=bt(o),i=s.bindJointAxis,d={};for(let b=0,r=i.length;b<r;b++){const p=i[b],h=J.querySelector('[sid="'+p.target+'"]');if(h){const _=h.parentElement;c(p.jointIndex,_)}}function c(b,r){const p=r.getAttribute("name"),h=n.joints[b];a.traverse(function(_){_.name===p&&(d[b]={object:_,transforms:Rn(r),joint:h,position:h.zeroPosition})})}const l=new de;_t={joints:n&&n.joints,getJointValue:function(b){const r=d[b];if(r)return r.position;console.warn("THREE.ColladaLoader: Joint "+b+" doesn't exist.")},setJointValue:function(b,r){const p=d[b];if(p){const h=p.joint;if(r>h.limits.max||r<h.limits.min)console.warn("THREE.ColladaLoader: Joint "+b+" value "+r+" outside of limits (min: "+h.limits.min+", max: "+h.limits.max+").");else if(h.static)console.warn("THREE.ColladaLoader: Joint "+b+" is static.");else{const _=p.object,k=h.axis,U=p.transforms;ne.identity();for(let R=0;R<U.length;R++){const S=U[R];if(S.sid&&S.sid.indexOf(b)!==-1)switch(h.type){case"revolute":ne.multiply(l.makeRotationAxis(k,Le.degToRad(r)));break;case"prismatic":ne.multiply(l.makeTranslation(k.x*r,k.y*r,k.z*r));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+h.type);break}else switch(S.type){case"matrix":ne.multiply(S.obj);break;case"translate":ne.multiply(l.makeTranslation(S.obj.x,S.obj.y,S.obj.z));break;case"scale":ne.scale(S.obj);break;case"rotate":ne.multiply(l.makeRotationAxis(S.obj,S.angle));break}}_.matrix.copy(ne),_.matrix.decompose(_.position,_.quaternion,_.scale),d[b].position=r}}else console.log("THREE.ColladaLoader: "+b+" does not exist.")}}}function Rn(t){const e=[],o=J.querySelector('[id="'+t.id+'"]');for(let n=0;n<o.childNodes.length;n++){const s=o.childNodes[n];if(s.nodeType!==1)continue;let a,i;switch(s.nodeName){case"matrix":a=g(s.textContent);const d=new de().fromArray(a).transpose();e.push({sid:s.getAttribute("sid"),type:s.nodeName,obj:d});break;case"translate":case"scale":a=g(s.textContent),i=new me().fromArray(a),e.push({sid:s.getAttribute("sid"),type:s.nodeName,obj:i});break;case"rotate":a=g(s.textContent),i=new me().fromArray(a);const c=Le.degToRad(a[3]);e.push({sid:s.getAttribute("sid"),type:s.nodeName,obj:i,angle:c});break}}return e}function Pn(t){const e=t.getElementsByTagName("node");for(let o=0;o<e.length;o++){const n=e[o];n.hasAttribute("id")===!1&&n.setAttribute("id",Q())}}const ne=new de,Ne=new me;function Ye(t){const e={name:t.getAttribute("name")||"",type:t.getAttribute("type"),id:t.getAttribute("id"),sid:t.getAttribute("sid"),matrix:new de,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];if(n.nodeType!==1)continue;let s;switch(n.nodeName){case"node":e.nodes.push(n.getAttribute("id")),Ye(n);break;case"instance_camera":e.instanceCameras.push(P(n.getAttribute("url")));break;case"instance_controller":e.instanceControllers.push(ht(n));break;case"instance_light":e.instanceLights.push(P(n.getAttribute("url")));break;case"instance_geometry":e.instanceGeometries.push(ht(n));break;case"instance_node":e.instanceNodes.push(P(n.getAttribute("url")));break;case"matrix":s=g(n.textContent),e.matrix.multiply(ne.fromArray(s).transpose()),e.transforms[n.getAttribute("sid")]=n.nodeName;break;case"translate":s=g(n.textContent),Ne.fromArray(s),e.matrix.multiply(ne.makeTranslation(Ne.x,Ne.y,Ne.z)),e.transforms[n.getAttribute("sid")]=n.nodeName;break;case"rotate":s=g(n.textContent);const a=Le.degToRad(s[3]);e.matrix.multiply(ne.makeRotationAxis(Ne.fromArray(s),a)),e.transforms[n.getAttribute("sid")]=n.nodeName;break;case"scale":s=g(n.textContent),e.matrix.scale(Ne.fromArray(s)),e.transforms[n.getAttribute("sid")]=n.nodeName;break;case"extra":break;default:console.log(n)}}return pt(e.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",e.id):A.nodes[e.id]=e,e}function ht(t){const e={id:P(t.getAttribute("url")),materials:{},skeletons:[]};for(let o=0;o<t.childNodes.length;o++){const n=t.childNodes[o];switch(n.nodeName){case"bind_material":const s=n.getElementsByTagName("instance_material");for(let a=0;a<s.length;a++){const i=s[a],d=i.getAttribute("symbol"),c=i.getAttribute("target");e.materials[d]=P(c)}break;case"skeleton":e.skeletons.push(P(n.textContent));break}}return e}function Gn(t,e){const o=[],n=[];let s,a,i;for(s=0;s<t.length;s++){const l=t[s];let b;if(pt(l))b=Te(l),ft(b,e,o);else if(Fn(l)){const p=A.visualScenes[l].children;for(let h=0;h<p.length;h++){const _=p[h];if(_.type==="JOINT"){const k=Te(_.id);ft(k,e,o)}}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",l)}for(s=0;s<e.length;s++)for(a=0;a<o.length;a++)if(i=o[a],i.bone.name===e[s].name){n[s]=i,i.processed=!0;break}for(s=0;s<o.length;s++)i=o[s],i.processed===!1&&(n.push(i),i.processed=!0);const d=[],c=[];for(s=0;s<n.length;s++)i=n[s],d.push(i.bone),c.push(i.boneInverse);return new mo(d,c)}function ft(t,e,o){t.traverse(function(n){if(n.isBone===!0){let s;for(let a=0;a<e.length;a++){const i=e[a];if(i.name===n.name){s=i.boneInverse;break}}s===void 0&&(s=new de),o.push({bone:n,boneInverse:s,processed:!1})}})}function On(t){const e=[],o=t.matrix,n=t.nodes,s=t.type,a=t.instanceCameras,i=t.instanceControllers,d=t.instanceLights,c=t.instanceGeometries,l=t.instanceNodes;for(let r=0,p=n.length;r<p;r++)e.push(Te(n[r]));for(let r=0,p=a.length;r<p;r++){const h=cn(a[r]);h!==null&&e.push(h.clone())}for(let r=0,p=i.length;r<p;r++){const h=i[r],_=N(h.id),k=lt(_.id),U=mt(k,h.materials),R=h.skeletons,S=_.skin.joints,I=Gn(R,S);for(let le=0,ee=U.length;le<ee;le++){const Ae=U[le];Ae.isSkinnedMesh&&(Ae.bind(I,_.skin.bindMatrix),Ae.normalizeSkinWeights()),e.push(Ae)}}for(let r=0,p=d.length;r<p;r++){const h=hn(d[r]);h!==null&&e.push(h.clone())}for(let r=0,p=c.length;r<p;r++){const h=c[r],_=lt(h.id),k=mt(_,h.materials);for(let U=0,R=k.length;U<R;U++)e.push(k[U])}for(let r=0,p=l.length;r<p;r++)e.push(Te(l[r]).clone());let b;if(n.length===0&&e.length===1)b=e[0];else{b=s==="JOINT"?new lo:new xt;for(let r=0;r<e.length;r++)b.add(e[r])}return b.name=s==="JOINT"?t.sid:t.name,b.matrix.copy(o),b.matrix.decompose(b.position,b.quaternion,b.scale),b}const qn=new At({name:Tt.DEFAULT_MATERIAL_NAME,color:16711935});function Bn(t,e){const o=[];for(let n=0,s=t.length;n<s;n++){const a=e[t[n]];a===void 0?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",t[n]),o.push(qn)):o.push(nn(a))}return o}function mt(t,e){const o=[];for(const n in t){const s=t[n],a=Bn(s.materialKeys,e);if(a.length===0&&(n==="lines"||n==="linestrips"?a.push(new Mt):a.push(new vt)),n==="lines"||n==="linestrips")for(let l=0,b=a.length;l<b;l++){const r=a[l];if(r.isMeshPhongMaterial===!0||r.isMeshLambertMaterial===!0){const p=new Mt;p.color.copy(r.color),p.opacity=r.opacity,p.transparent=r.transparent,a[l]=p}}const i=s.data.attributes.skinIndex!==void 0,d=a.length===1?a[0]:a;let c;switch(n){case"lines":c=new fo(s.data,d);break;case"linestrips":c=new ho(s.data,d);break;case"triangles":case"polylist":i?c=new uo(s.data,d):c=new qt(s.data,d);break}o.push(c)}return o}function pt(t){return A.nodes[t]!==void 0}function Te(t){return $(A.nodes[t],On)}function Hn(t){const e={name:t.getAttribute("name"),children:[]};Pn(t);const o=f(t,"node");for(let n=0;n<o.length;n++)e.children.push(Ye(o[n]));A.visualScenes[t.getAttribute("id")]=e}function gt(t){const e=new xt;e.name=t.name;const o=t.children;for(let n=0;n<o.length;n++){const s=o[n];e.add(Te(s.id))}return e}function Fn(t){return A.visualScenes[t]!==void 0}function bt(t){return $(A.visualScenes[t],gt)}function Un(t){const e=f(t,"instance_visual_scene")[0];return bt(P(e.getAttribute("url")))}function zn(){const t=A.clips;if(re(t)===!0){if(re(A.animations)===!1){const e=[];for(const o in A.animations){const n=Re(o);for(let s=0,a=n.length;s<a;s++)e.push(n[s])}qe.push(new Et("default",-1,e))}}else for(const e in t)qe.push(B(e))}function Vn(t){let e="";const o=[t];for(;o.length;){const n=o.shift();n.nodeType===Node.TEXT_NODE?e+=n.textContent:(e+=`
`,o.push(...n.childNodes))}return e.trim()}if(x.length===0)return{scene:new Pt};const yt=new DOMParser().parseFromString(x,"application/xml"),J=f(yt,"COLLADA")[0],Xe=yt.getElementsByTagName("parsererror")[0];if(Xe!==void 0){const t=f(Xe,"div")[0];let e;return t?e=t.textContent:e=Vn(Xe),console.error(`THREE.ColladaLoader: Failed to parse collada file.
`,e),null}const Wn=J.getAttribute("version");console.debug("THREE.ColladaLoader: File version",Wn);const kt=Ce(f(J,"asset")[0]),wt=new Qn(this.manager);wt.setPath(this.resourcePath||L).setCrossOrigin(this.crossOrigin);let Ze;It&&(Ze=new It(this.manager),Ze.setPath(this.resourcePath||L));const Oe=new Ct,qe=[];let _t={},Dn=0;const A={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};Y(J,"library_animations","animation",Ee),Y(J,"library_animation_clips","animation_clip",m),Y(J,"library_controllers","controller",G),Y(J,"library_images","image",u),Y(J,"library_effects","effect",oe),Y(J,"library_materials","material",en),Y(J,"library_cameras","camera",on),Y(J,"library_lights","light",ln),Y(J,"library_geometries","geometry",fn),Y(J,"library_nodes","node",Ye),Y(J,"library_visual_scenes","visual_scene",Hn),Y(J,"library_kinematics_models","kinematics_model",kn),Y(J,"library_physics_models","physics_model",En),Y(J,"scene","instance_kinematics_scene",Ln),te(A.animations,je),te(A.clips,V),te(A.controllers,v),te(A.images,T),te(A.effects,st),te(A.materials,at),te(A.cameras,it),te(A.lights,rt),te(A.geometries,ct),te(A.visualScenes,gt),zn(),jn();const Be=Un(f(J,"scene")[0]);return Be.animations=qe,kt.upAxis==="Z_UP"&&(console.warn("THREE.ColladaLoader: You are loading an asset with a Z-UP coordinate system. The loader just rotates the asset to transform it into Y-UP. The vertex data are not converted, see #24289."),Be.rotation.set(-Math.PI/2,0,0)),Be.scale.multiplyScalar(kt.unit),{get animations(){return console.warn("THREE.ColladaLoader: Please access animations over scene.animations now."),qe},kinematics:_t,library:A,scene:Be}}}const Ft={"Royal Esplanade":"https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/equirectangular/royal_esplanade_1k.hdr","Moonless Golf":"https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/equirectangular/moonless_golf_1k.hdr",Overpass:"https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/equirectangular/pedestrian_overpass_1k.hdr","Venice Sunset":"https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/equirectangular/venice_sunset_1k.hdr","Small Studio":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/studio_small_05_1k.hdr","Pfalzer Forest":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/phalzer_forest_01_1k.hdr","Leadenhall Market":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/leadenhall_market_1k.hdr",Kloppenheim:"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/kloppenheim_05_1k.hdr","Hilly Terrain":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/hilly_terrain_01_1k.hdr","Circus Arena":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/circus_arena_1k.hdr","Chinese Garden":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/chinese_garden_1k.hdr",Autoshop:"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/autoshop_01_1k.hdr","Measuring Lab":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/vintage_measuring_lab_2k.hdr","Whale Skeleton":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/whale_skeleton_2k.hdr","Hall of Mammals":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/hall_of_mammals_2k.hdr","Drachenfels Cellar":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/drachenfels_cellar_2k.hdr","Adams Place Bridge":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/adams_place_bridge_2k.hdr","Sepulchral Chapel Rotunda":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/sepulchral_chapel_rotunda_2k.hdr","Peppermint Powerplant":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/peppermint_powerplant_2k.hdr","Noon Grass":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/noon_grass_2k.hdr","Narrow Moonlit Road":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/narrow_moonlit_road_2k.hdr","St Peters Square Night":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/st_peters_square_night_2k.hdr","Brown Photostudio 01":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_01_2k.hdr","Rainforest Trail":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/rainforest_trail_2k.hdr","Brown Photostudio 07":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_07_2k.hdr","Brown Photostudio 06":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/brown_photostudio_06_2k.hdr","Dancing Hall":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/dancing_hall_2k.hdr","Aristea Wreck Puresky":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/aristea_wreck_puresky_2k.hdr","Modern Buildings 2":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/modern_buildings_2_2k.hdr","Thatch Chapel":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/thatch_chapel_2k.hdr",Vestibule:"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/vestibule_2k.hdr","Blocky Photo Studio":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/blocky_photo_studio_1k.hdr","Christmas Photo Studio 07":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/christmas_photo_studio_07_2k.hdr","Aerodynamics Workshop":"https://raw.githubusercontent.com/gkjohnson/3d-demo-data/master/hdri/aerodynamics_workshop_1k.hdr"},Me=window.MODEL_LIST||{},y={multipleImportanceSampling:!0,acesToneMapping:!0,renderScale:1/window.devicePixelRatio,tiles:2,model:"",envMap:Ft["Aristea Wreck Puresky"],gradientTop:"#bfd8ff",gradientBottom:"#ffffff",environmentIntensity:1,environmentRotation:0,cameraProjection:"Perspective",backgroundType:"Gradient",bgGradientTop:"#111111",bgGradientBottom:"#000000",backgroundBlur:0,transparentBackground:!1,checkerboardTransparency:!0,enable:!0,bounces:5,filterGlossyFactor:.5,pause:!1,floorColor:"#111111",floorOpacity:1,floorRoughness:.2,floorMetalness:.2,...Io()};let fe,ie,$e,W,se,be,ye,ue,ze,K,X,he,ce;const Ue=2;qo();async function qo(){ce=new jo,ce.attach(document.body),se=new po({antialias:!0}),se.toneMapping=Bt,document.body.appendChild(se.domElement),W=new Po(se),W.setBVHWorker(new Ro),W.physicallyCorrectLights=!0,W.tiles.set(y.tiles,y.tiles),W.multipleImportanceSampling=y.multipleImportanceSampling,W.transmissiveBounces=10;const w=window.innerWidth/window.innerHeight;ye=new Qe(60,w,.025,500),ye.position.set(-1,.25,1);const x=Ue/w;be=new Ot(Ue/-2,Ue/2,x/2,x/-2,0,100),be.position.set(-1,.25,1),he=new Go,he.topColor.set(y.bgGradientTop),he.bottomColor.set(y.bgGradientBottom),he.update(),ze=new So(ye,se.domElement),ze.addEventListener("change",()=>{W.updateCamera()}),K=new Pt,K.background=he;const L=Mo(2048);fe=new qt(new go,new Ht({map:L,transparent:!0,color:1118481,roughness:.1,metalness:0,side:Gt})),fe.scale.setScalar(5),fe.rotation.x=-Math.PI/2,K.add(fe),$e=new Lo,document.body.appendChild($e.dom),Vt(y.cameraProjection),jt(),zt(),Rt(),Ut(),window.addEventListener("resize",Rt),window.addEventListener("hashchange",jt)}function Ut(){requestAnimationFrame(Ut),$e.update(),X&&(y.enable?(!y.pause||W.samples<1)&&W.renderSample():se.render(K,ue),ce.setSamples(W.samples,W.isCompiling))}function Z(){W.multipleImportanceSampling=y.multipleImportanceSampling,W.bounces=y.bounces,W.filterGlossyFactor=y.filterGlossyFactor,W.renderScale=y.renderScale,fe.material.color.set(y.floorColor),fe.material.roughness=y.floorRoughness,fe.material.metalness=y.floorMetalness,fe.material.opacity=y.floorOpacity,K.environmentIntensity=y.environmentIntensity,K.environmentRotation.y=y.environmentRotation,K.backgroundBlurriness=y.backgroundBlur,y.backgroundType==="Gradient"?(he.topColor.set(y.bgGradientTop),he.bottomColor.set(y.bgGradientBottom),he.update(),K.background=he,K.backgroundIntensity=1,K.environmentRotation.y=0):(K.background=K.environment,K.backgroundIntensity=y.environmentIntensity,K.backgroundRotation.y=y.environmentRotation),y.transparentBackground&&(K.background=null,se.setClearAlpha(0)),W.updateMaterials(),W.updateEnvironment()}function jt(){let w="";if(window.location.hash){const x=decodeURI(window.location.hash.substring(1));x in Me&&(w=x)}w in Me||(w=Object.keys(Me)[0]),y.model=w,Fo()}function Rt(){const w=window.innerWidth,x=window.innerHeight,L=window.devicePixelRatio;se.setSize(w,x),se.setPixelRatio(L);const f=w/x;ye.aspect=f,ye.updateProjectionMatrix();const C=Ue/f;be.top=C/2,be.bottom=C/-2,be.updateProjectionMatrix(),W.updateCamera()}function Bo(){ie&&ie.destroy(),ie=new xo,ie.add(y,"model",Object.keys(Me).sort()).onChange(C=>{window.location.hash=C});const w=ie.addFolder("Path Tracer");w.add(y,"enable"),w.add(y,"pause"),w.add(y,"multipleImportanceSampling").onChange(Z),w.add(y,"acesToneMapping").onChange(C=>{se.toneMapping=C?Bt:No}),w.add(y,"bounces",1,20,1).onChange(Z),w.add(y,"filterGlossyFactor",0,1).onChange(Z),w.add(y,"renderScale",.1,1,.01).onChange(()=>{Z()}),w.add(y,"tiles",1,10,1).onChange(C=>{W.tiles.set(C,C)}),w.add(y,"cameraProjection",["Perspective","Orthographic"]).onChange(C=>{Vt(C)}),w.open();const x=ie.addFolder("environment");x.add(y,"envMap",Ft).name("map").onChange(zt),x.add(y,"environmentIntensity",0,10).onChange(Z).name("intensity"),x.add(y,"environmentRotation",0,2*Math.PI).onChange(Z),x.open();const L=ie.addFolder("background");L.add(y,"backgroundType",["Environment","Gradient"]).onChange(Z),L.addColor(y,"bgGradientTop").onChange(Z),L.addColor(y,"bgGradientBottom").onChange(Z),L.add(y,"backgroundBlur",0,1).onChange(Z),L.add(y,"transparentBackground",0,1).onChange(Z),L.add(y,"checkerboardTransparency").onChange(C=>{C?document.body.classList.add("checkerboard"):document.body.classList.remove("checkerboard")});const f=ie.addFolder("floor");f.addColor(y,"floorColor").onChange(Z),f.add(y,"floorRoughness",0,1).onChange(Z),f.add(y,"floorMetalness",0,1).onChange(Z),f.add(y,"floorOpacity",0,1).onChange(Z),f.close()}function zt(){new Ao().load(y.envMap,w=>{K.environment&&K.environment.dispose(),w.mapping=bo,K.environment=w,W.updateEnvironment(),Z()})}function Vt(w){ue&&(ye.position.copy(ue.position),be.position.copy(ue.position)),w==="Perspective"?ue=ye:ue=be,ze.object=ue,ze.update(),W.setCamera(ue)}function Ho(w,x){w.traverse(L=>{if(L.material){const f=L.material;if(f.opacity<.65&&f.opacity>.2){const C=new _o;for(const M in f)if(M in f){if(f[M]===null)continue;f[M].isTexture?C[M]=f[M]:f[M].copy&&f[M].constructor===C[M].constructor?C[M].copy(f[M]):typeof f[M]=="number"&&(C[M]=f[M])}C.opacity=1,C.transmission=1,C.ior=x;const g={};C.color.getHSL(g),g.l=Math.max(g.l,.35),C.color.setHSL(g.h,g.s,g.l),L.material=C}}})}async function Fo(){ie&&(document.body.classList.remove("checkerboard"),ie.destroy(),ie=null);const w=Me[y.model];se.domElement.style.visibility="hidden",ce.setPercentage(0),X&&(X.traverse(f=>{if(f.material){const C=f.material;for(const g in C)C[g]&&C[g].isTexture&&C[g].dispose()}}),K.remove(X),X=null);try{X=await Uo(w.url,f=>{ce.setPercentage(.5*f)})}catch(f){ce.setCredits("Failed to load model:"+f.message),ce.setPercentage(1)}w.removeEmission&&X.traverse(f=>{f.material&&(f.material.emissiveMap=null,f.material.emissiveIntensity=0)}),w.opacityToTransmission&&Ho(X,w.ior||1.5),X.traverse(f=>{f.material&&(f.material.thickness=1)}),w.postProcess&&w.postProcess(X),w.rotation&&X.rotation.set(...w.rotation);const x=new yo;x.setFromObject(X),X.position.addScaledVector(x.min,-.5).addScaledVector(x.max,-.5);const L=new ko;x.getBoundingSphere(L),X.scale.setScalar(1/L.radius),X.position.multiplyScalar(1/L.radius),x.setFromObject(X),fe.position.y=x.min.y,K.add(X),await W.setSceneAsync(K,ue,{onProgress:f=>ce.setPercentage(.5+.5*f)}),ce.setPercentage(1),ce.setCredits(w.credit||""),y.bounces=w.bounces||5,y.floorColor=w.floorColor||"#111111",y.floorRoughness=w.floorRoughness||.2,y.floorMetalness=w.floorMetalness||.2,y.bgGradientTop=w.gradientTop||"#111111",y.bgGradientBottom=w.gradientBot||"#000000",Bo(),Z(),se.domElement.style.visibility="visible",y.checkerboardTransparency&&document.body.classList.add("checkerboard")}async function Uo(w,x){const L=new wo;if(/dae$/i.test(w)){const f=new Promise(g=>L.onLoad=g),C=await new Oo(L).loadAsync(w,g=>{g.total!==0&&g.total>=g.loaded&&x(g.loaded/g.total)});return await f,C.scene.scale.setScalar(1),C.scene.traverse(g=>{const{material:M}=g;M&&M.isMeshPhongMaterial&&(g.material=new Ht({color:M.color,roughness:M.roughness||0,metalness:M.metalness||0,map:M.map||null}))}),C.scene}else if(/(gltf|glb)$/i.test(w)){const f=new Promise(g=>L.onLoad=g),C=await new Co(L).setMeshoptDecoder(To).loadAsync(w,g=>{g.total!==0&&g.total>=g.loaded&&x(g.loaded/g.total)});return await f,C.scene}else if(/mpd$/i.test(w)){L.onProgress=(Q,re,Ce)=>{x(re/Ce)};const f=new Promise(Q=>L.onLoad=Q),C=new Eo(L);await C.preloadMaterials("https://raw.githubusercontent.com/gkjohnson/ldraw-parts-library/master/colors/ldcfgalt.ldr");const g=await C.setPartsLibraryPath("https://raw.githubusercontent.com/gkjohnson/ldraw-parts-library/master/complete/ldraw/").loadAsync(w);await f;const M=vo.mergeObject(g);M.rotation.set(Math.PI,0,0);const P=[];return M.traverse(Q=>{Q.isLineSegments&&P.push(Q),Q.isMesh&&(Q.material.roughness*=.25)}),P.forEach(Q=>{Q.parent.remove(Q)}),M}}
