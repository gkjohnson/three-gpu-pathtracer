import{B as p,ah as w}from"./MaterialBase-byhyp4gt.js";import{M as g,i as k,e as M,c as x}from"./pcg.glsl-Dh-2-BlJ.js";class b{constructor(r){this.name="WorkerBase",this.running=!1,this.worker=r,this.worker.onerror=e=>{throw e.message?new Error(`${this.name}: Could not create Web Worker with error "${e.message}"`):new Error(`${this.name}: Could not create Web Worker.`)}}runTask(){}generate(...r){if(this.running)throw new Error("GenerateMeshBVHWorker: Already running job.");if(this.worker===null)throw new Error("GenerateMeshBVHWorker: Worker has been disposed.");this.running=!0;const e=this.runTask(this.worker,...r);return e.finally(()=>{this.running=!1}),e}dispose(){this.worker.terminate(),this.worker=null}}class H extends b{constructor(){const r=new Worker(new URL(""+new URL("generateMeshBVH.worker-C0cqvstH.js",import.meta.url).href,import.meta.url),{type:"module"});super(r),this.name="GenerateMeshBVHWorker"}runTask(r,e,s={}){return new Promise((B,i)=>{if(e.getAttribute("position").isInterleavedBufferAttribute||e.index&&e.index.isInterleavedBufferAttribute)throw new Error("GenerateMeshBVHWorker: InterleavedBufferAttribute are not supported for the geometry attributes.");r.onerror=n=>{i(new Error(`GenerateMeshBVHWorker: ${n.message}`))},r.onmessage=n=>{const{data:o}=n;if(o.error)i(new Error(o.error)),r.onmessage=null;else if(o.serialized){const{serialized:a,position:d}=o,f=g.deserialize(a,e,{setIndex:!1}),c=Object.assign({setBoundingBox:!0},s);if(e.attributes.position.array=d,a.index)if(e.index)e.index.array=a.index;else{const P=new p(a.index,1,!1);e.setIndex(P)}c.setBoundingBox&&(e.boundingBox=f.getBoundingBox(new w)),s.onProgress&&s.onProgress(o.progress),B(f),r.onmessage=null}else s.onProgress&&s.onProgress(o.progress)};const u=e.index?e.index.array:null,l=e.attributes.position.array,t=[l];u&&t.push(u),r.postMessage({index:u,position:l,options:{...s,onProgress:null,includedProgressCallback:!!s.onProgress,groups:[...e.groups]}},t.map(n=>n.buffer).filter(n=>typeof SharedArrayBuffer>"u"||!(n instanceof SharedArrayBuffer)))})}}const W=typeof navigator<"u"?navigator.hardwareConcurrency:4;class A extends b{constructor(){const r=new Worker(new URL(""+new URL("parallelMeshBVH.worker-BgFKX_E_.js",import.meta.url).href,import.meta.url),{type:"module"});if(super(r),this.name="ParallelMeshBVHWorker",this.maxWorkerCount=Math.max(W,4),!k())throw new Error("ParallelMeshBVHWorker: Shared Array Buffers are not supported.")}runTask(r,e,s={}){return new Promise((B,i)=>{if(!e.index&&!s.indirect&&M(e,s),e.getAttribute("position").isInterleavedBufferAttribute||e.index&&e.index.isInterleavedBufferAttribute)throw new Error("ParallelMeshBVHWorker: InterleavedBufferAttribute are not supported for the geometry attributes.");r.onerror=t=>{i(new Error(`ParallelMeshBVHWorker: ${t.message}`))},r.onmessage=t=>{const{data:n}=t;if(n.error)i(new Error(n.error)),r.onmessage=null;else if(n.serialized){const{serialized:o,position:a}=n,d=g.deserialize(o,e,{setIndex:!1}),f={setBoundingBox:!0,...s};if(e.attributes.position.array=a,o.index)if(e.index)e.index.array=o.index;else{const c=new p(o.index,1,!1);e.setIndex(c)}f.setBoundingBox&&(e.boundingBox=d.getBoundingBox(new w)),s.onProgress&&s.onProgress(n.progress),B(d),r.onmessage=null}else s.onProgress&&s.onProgress(n.progress)};const u=e.index?e.index.array:null,l=e.attributes.position.array;r.postMessage({operation:"BUILD_BVH",maxWorkerCount:this.maxWorkerCount,index:x(u,SharedArrayBuffer),position:x(l,SharedArrayBuffer),options:{...s,onProgress:null,includedProgressCallback:!!s.onProgress,groups:[...e.groups]}})})}}class E{constructor(){if(k())return new A;{console.warn("ParallelMeshBVHWorker: SharedArrayBuffers not supported. Falling back to single-threaded GenerateMeshBVHWorker.");const r=new H;return r.maxWorkerCount=W,r}}}export{E as P};
