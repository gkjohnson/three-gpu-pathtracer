function e(e,t,r,a){Object.defineProperty(e,t,{get:r,set:a,enumerable:!0,configurable:!0})}var t=globalThis,r={},a={},i=t.parcelRequire5b70;null==i&&((i=function(e){if(e in r)return r[e].exports;if(e in a){var t=a[e];delete a[e];var i={id:e,exports:{}};return r[e]=i,t.call(i.exports,i,i.exports),i.exports}var n=Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}).register=function(e,t){a[e]=t},t.parcelRequire5b70=i);var n=i.register;n("cpS3d",function(t,r){e(t.exports,"LDrawLoader",()=>M);var a=i("ilwiq");let n=a.SRGBColorSpace,o=new a.Vector3,l=new a.Vector3;class s extends a.ShaderMaterial{constructor(e){super({uniforms:(0,a.UniformsUtils).merge([a.UniformsLib.fog,{diffuse:{value:new a.Color},opacity:{value:1}}]),vertexShader:`
				attribute vec3 control0;
				attribute vec3 control1;
				attribute vec3 direction;
				varying float discardFlag;

				#include <common>
				#include <color_pars_vertex>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>
				void main() {
					#include <color_vertex>

					vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
					gl_Position = projectionMatrix * mvPosition;

					// Transform the line segment ends and control points into camera clip space
					vec4 c0 = projectionMatrix * modelViewMatrix * vec4( control0, 1.0 );
					vec4 c1 = projectionMatrix * modelViewMatrix * vec4( control1, 1.0 );
					vec4 p0 = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
					vec4 p1 = projectionMatrix * modelViewMatrix * vec4( position + direction, 1.0 );

					c0.xy /= c0.w;
					c1.xy /= c1.w;
					p0.xy /= p0.w;
					p1.xy /= p1.w;

					// Get the direction of the segment and an orthogonal vector
					vec2 dir = p1.xy - p0.xy;
					vec2 norm = vec2( -dir.y, dir.x );

					// Get control point directions from the line
					vec2 c0dir = c0.xy - p1.xy;
					vec2 c1dir = c1.xy - p1.xy;

					// If the vectors to the controls points are pointed in different directions away
					// from the line segment then the line should not be drawn.
					float d0 = dot( normalize( norm ), normalize( c0dir ) );
					float d1 = dot( normalize( norm ), normalize( c1dir ) );
					discardFlag = float( sign( d0 ) != sign( d1 ) );

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>
				}
			`,fragmentShader:`
			uniform vec3 diffuse;
			uniform float opacity;
			varying float discardFlag;

			#include <common>
			#include <color_pars_fragment>
			#include <fog_pars_fragment>
			#include <logdepthbuf_pars_fragment>
			#include <clipping_planes_pars_fragment>
			void main() {

				if ( discardFlag > 0.5 ) discard;

				#include <clipping_planes_fragment>
				vec3 outgoingLight = vec3( 0.0 );
				vec4 diffuseColor = vec4( diffuse, opacity );
				#include <logdepthbuf_fragment>
				#include <color_fragment>
				outgoingLight = diffuseColor.rgb; // simple shader
				gl_FragColor = vec4( outgoingLight, diffuseColor.a );
				#include <tonemapping_fragment>
				#include <colorspace_fragment>
				#include <fog_fragment>
				#include <premultiplied_alpha_fragment>
			}
			`}),Object.defineProperties(this,{opacity:{get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},color:{get:function(){return this.uniforms.diffuse.value}}}),this.setValues(e),this.isLDrawConditionalLineMaterial=!0}}class c extends a.LineSegments{constructor(e,t){super(e,t),this.isConditionalLine=!0}}let u=new a.Ray;function d(e){return"Part"===e||"Unofficial_Part"===e}class h{constructor(e,t){this.line=e,this.lineLength=e.length,this.currentCharIndex=0,this.currentChar=" ",this.lineNumber=t}seekNonSpace(){for(;this.currentCharIndex<this.lineLength;){if(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"	"!==this.currentChar)return;this.currentCharIndex++}}getToken(){let e=this.currentCharIndex++;for(;this.currentCharIndex<this.lineLength&&(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"	"!==this.currentChar);)this.currentCharIndex++;let t=this.currentCharIndex;return this.seekNonSpace(),this.line.substring(e,t)}getVector(){return new a.Vector3(parseFloat(this.getToken()),parseFloat(this.getToken()),parseFloat(this.getToken()))}getRemainingString(){return this.line.substring(this.currentCharIndex,this.lineLength)}isAtTheEnd(){return this.currentCharIndex>=this.lineLength}setToEnd(){this.currentCharIndex=this.lineLength}getLineNumberString(){return this.lineNumber>=0?" at line "+this.lineNumber:""}}class g{constructor(e){this.loader=e,this._cache={}}cloneResult(e){let t={};return t.faces=e.faces.map(e=>({colorCode:e.colorCode,material:e.material,vertices:e.vertices.map(e=>e.clone()),normals:e.normals.map(()=>null),faceNormal:null})),t.conditionalSegments=e.conditionalSegments.map(e=>({colorCode:e.colorCode,material:e.material,vertices:e.vertices.map(e=>e.clone()),controlPoints:e.controlPoints.map(e=>e.clone())})),t.lineSegments=e.lineSegments.map(e=>({colorCode:e.colorCode,material:e.material,vertices:e.vertices.map(e=>e.clone())})),t.type=e.type,t.category=e.category,t.keywords=e.keywords,t.author=e.author,t.subobjects=e.subobjects,t.fileName=e.fileName,t.totalFaces=e.totalFaces,t.startingBuildingStep=e.startingBuildingStep,t.materials=e.materials,t.group=null,t}async fetchData(e){let t=!1,r=0;for(;6!==r;){let i=e;switch(r){case 3:r+=1;break;case 0:i="parts/"+i,r+=1;break;case 1:i="p/"+i,r+=1;break;case 2:i="models/"+i,r+=1;break;case 4:i=e.substring(0,e.lastIndexOf("/")+1)+i,r+=1;break;case 5:t?r=6:(i=e=e.toLowerCase(),t=!0,r=0)}let n=this.loader,o=new a.FileLoader(n.manager);o.setPath(n.partsLibraryPath),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials);try{return await o.loadAsync(i)}catch(e){continue}}throw Error('LDrawLoader: Subobject "'+e+'" could not be loaded.')}parse(e,t=null){let r=this.loader,i=[],n=[],o=[],l=[],s={},c=e=>s[e]||null,u="Model",d=null,g=null,m=null,p=0;-1!==e.indexOf("\r\n")&&(e=e.replace(/\r\n/g,"\n"));let f=e.split("\n"),C=f.length,M=!1,b=null,w=null,y=!1,L=!0,v=!1,x=!0,k=!1;for(let e=0;e<C;e++){let t,C,E,S,A,D,T,N,_;let F=f[e];if(0===F.length)continue;if(M){F.startsWith("0 FILE ")?(this.setData(b,w),b=F.substring(7),w=""):w+=F+"\n";continue}let V=new h(F,e+1);if(V.seekNonSpace(),V.isAtTheEnd())continue;let I=V.getToken();switch(I){case"0":let R=V.getToken();if(R)switch(R){case"!LDRAW_ORG":u=V.getToken();break;case"!COLOUR":(t=r.parseColorMetaDirective(V))?s[t.userData.code]=t:console.warn("LDrawLoader: Error parsing material"+V.getLineNumberString());break;case"!CATEGORY":d=V.getToken();break;case"!KEYWORDS":let B=V.getRemainingString().split(",");B.length>0&&(g||(g=[]),B.forEach(function(e){g.push(e.trim())}));break;case"FILE":e>0&&(M=!0,b=V.getRemainingString(),w="",y=!1,L=!0);break;case"BFC":for(;!V.isAtTheEnd();){let e=V.getToken();switch(e){case"CERTIFY":case"NOCERTIFY":y="CERTIFY"===e,L=!0;break;case"CW":case"CCW":L="CCW"===e;break;case"INVERTNEXT":v=!0;break;case"CLIP":case"NOCLIP":x="CLIP"===e;break;default:console.warn('THREE.LDrawLoader: BFC directive "'+e+'" is unknown.')}}break;case"STEP":k=!0;break;case"Author:":m=V.getToken()}break;case"1":t=c(C=V.getToken());let O=parseFloat(V.getToken()),P=parseFloat(V.getToken()),W=parseFloat(V.getToken()),U=parseFloat(V.getToken()),z=parseFloat(V.getToken()),G=parseFloat(V.getToken()),j=parseFloat(V.getToken()),q=parseFloat(V.getToken()),H=parseFloat(V.getToken()),$=parseFloat(V.getToken()),Y=parseFloat(V.getToken()),K=parseFloat(V.getToken()),X=new(0,a.Matrix4)().set(U,z,G,O,j,q,H,P,$,Y,K,W,0,0,0,1),J=V.getRemainingString().trim().replace(/\\/g,"/");r.fileMap[J]?J=r.fileMap[J]:J.startsWith("s/")?J="parts/"+J:J.startsWith("48/")&&(J="p/"+J),l.push({material:t,colorCode:C,matrix:X,fileName:J,inverted:v,startingBuildingStep:k}),k=!1,v=!1;break;case"2":E={material:t=c(C=V.getToken()),colorCode:C,vertices:[D=V.getVector(),T=V.getVector()]},n.push(E);break;case"5":t=c(C=V.getToken()),D=V.getVector(),E={material:t,colorCode:C,vertices:[D,T=V.getVector()],controlPoints:[V.getVector(),V.getVector()]},o.push(E);break;case"3":t=c(C=V.getToken()),S=L,A=!y||!x,!0===S?(D=V.getVector(),T=V.getVector(),N=V.getVector()):(N=V.getVector(),T=V.getVector(),D=V.getVector()),i.push({material:t,colorCode:C,faceNormal:null,vertices:[D,T,N],normals:[null,null,null]}),p++,!0===A&&(i.push({material:t,colorCode:C,faceNormal:null,vertices:[N,T,D],normals:[null,null,null]}),p++);break;case"4":t=c(C=V.getToken()),S=L,A=!y||!x,!0===S?(D=V.getVector(),T=V.getVector(),N=V.getVector(),_=V.getVector()):(_=V.getVector(),N=V.getVector(),T=V.getVector(),D=V.getVector()),i.push({material:t,colorCode:C,faceNormal:null,vertices:[D,T,N,_],normals:[null,null,null,null]}),p+=2,!0===A&&(i.push({material:t,colorCode:C,faceNormal:null,vertices:[_,N,T,D],normals:[null,null,null,null]}),p+=2);break;default:throw Error('LDrawLoader: Unknown line type "'+I+'"'+V.getLineNumberString()+".")}}return M&&this.setData(b,w),{faces:i,conditionalSegments:o,lineSegments:n,type:u,category:d,keywords:g,author:m,subobjects:l,totalFaces:p,startingBuildingStep:k,materials:s,fileName:t,group:null}}getData(e,t=!0){let r=e.toLowerCase(),a=this._cache[r];return null===a||a instanceof Promise?null:t?this.cloneResult(a):a}async ensureDataLoaded(e){let t=e.toLowerCase();t in this._cache||(this._cache[t]=this.fetchData(e).then(r=>{let a=this.parse(r,e);return this._cache[t]=a,a})),await this._cache[t]}setData(e,t){let r=e.toLowerCase();this._cache[r]=this.parse(t,e)}}function m(e,t,r,a){return(!a&&"16"===e||a&&"24"===e)&&(e=t),r[e]||null}class p{constructor(e){this.loader=e,this.parseCache=new g(e),this._cache={}}async processIntoMesh(e){let t=this.loader,r=this.parseCache,i=new Set,n=async(e,o=null)=>{let l=e.subobjects,s=[];for(let e=0,t=l.length;e<t;e++){let t=l[e],a=r.ensureDataLoaded(t.fileName).then(()=>{var e;return(e=r.getData(t.fileName,!1).type,/primitive/i.test(e)||"Subpart"===e)?n(r.getData(t.fileName),t):this.loadModel(t.fileName).catch(e=>(console.warn(e),null))});s.push(a)}let c=new a.Group;c.userData.category=e.category,c.userData.keywords=e.keywords,c.userData.author=e.author,c.userData.type=e.type,c.userData.fileName=e.fileName,e.group=c;let u=await Promise.all(s);for(let r=0,a=u.length;r<a;r++){let a=e.subobjects[r],n=u[r];if(null===n)continue;if(n.isGroup){a.matrix.decompose(n.position,n.quaternion,n.scale),n.userData.startingBuildingStep=a.startingBuildingStep,n.name=a.fileName,t.applyMaterialsToMesh(n,a.colorCode,e.materials),n.userData.colorCode=a.colorCode,c.add(n);continue}n.group.children.length&&c.add(n.group);let o=e.lineSegments,l=e.conditionalSegments,s=e.faces,d=n.lineSegments,h=n.conditionalSegments,g=n.faces,p=a.matrix,f=a.inverted,C=0>p.determinant(),M=a.colorCode,b="16"===M?"24":M;for(let t=0,r=d.length;t<r;t++){let r=d[t],a=r.vertices;a[0].applyMatrix4(p),a[1].applyMatrix4(p),r.colorCode="24"===r.colorCode?b:r.colorCode,r.material=r.material||m(r.colorCode,r.colorCode,e.materials,!0),o.push(r)}for(let t=0,r=h.length;t<r;t++){let r=h[t],a=r.vertices,i=r.controlPoints;a[0].applyMatrix4(p),a[1].applyMatrix4(p),i[0].applyMatrix4(p),i[1].applyMatrix4(p),r.colorCode="24"===r.colorCode?b:r.colorCode,r.material=r.material||m(r.colorCode,r.colorCode,e.materials,!0),l.push(r)}for(let t=0,r=g.length;t<r;t++){let r=g[t],a=r.vertices;for(let e=0,t=a.length;e<t;e++)a[e].applyMatrix4(p);r.colorCode="16"===r.colorCode?M:r.colorCode,r.material=r.material||m(r.colorCode,M,e.materials,!1),i.add(r.colorCode),C!==f&&a.reverse(),s.push(r)}e.totalFaces+=n.totalFaces}return o&&(t.applyMaterialsToMesh(c,o.colorCode,e.materials),c.userData.colorCode=o.colorCode),e};for(let t=0,r=e.faces;t<r;t++)i.add(e.faces[t].colorCode);if(await n(e),t.smoothNormals){let t=i.size>1;(function(e){for(let t=0,r=e.length;t<r;t++){let r=e[t],i=r.vertices,n=i[0],s=i[1],c=i[2];o.subVectors(s,n),l.subVectors(c,s),r.faceNormal=new(0,a.Vector3)().crossVectors(o,l).normalize()}})(e.faces),function(e,t,r=!1){let i=(1+1e-10)*100;function n(e){let t=~~(e.x*i),r=~~(e.y*i),a=~~(e.z*i);return`${t},${r},${a}`}function o(e,t){return`${n(e)}_${n(t)}`}function l(e,t,r){r.direction.subVectors(t,e).normalize();let a=e.dot(r.direction);return r.origin.copy(e).addScaledVector(r.direction,-a),r}function s(e){return o(e.origin,e.direction)}let c=new Set,d=new Map,h={},g=[];for(let e=0,i=t.length;e<i;e++){let i=t[e].vertices,n=i[0],u=i[1];if(c.add(o(n,u)),c.add(o(u,n)),r){let e=l(n,u,new a.Ray),t=s(e);if(!d.has(t)){l(u,n,e);let r=s(e),a={ray:e,distances:[]};d.set(t,a),d.set(r,a)}let r=d.get(t),i=r.ray.direction.dot(n),o=r.ray.direction.dot(u);i>o&&([i,o]=[o,i]),r.distances.push(i,o)}}for(let t=0,a=e.length;t<a;t++){let a=e[t],i=a.vertices,n=i.length;for(let e=0;e<n;e++){let t=e,g=(e+1)%n,m=i[t],p=i[g],f=o(m,p);if(c.has(f))continue;if(r){l(m,p,u);let e=s(u);if(d.has(e)){let{ray:t,distances:r}=d.get(e),a=t.direction.dot(m),i=t.direction.dot(p);a>i&&([a,i]=[i,a]);let n=!1;for(let e=0,t=r.length;e<t;e+=2)if(a>=r[e]&&i<=r[e+1]){n=!0;break}if(n)continue}}let C={index:t,tri:a};h[f]=C}}for(;;){let e=null;for(let t in h){e=h[t];break}if(null===e)break;let t=[e];for(;t.length>0;){let e=t.pop().tri,r=e.vertices,i=e.normals,n=e.faceNormal,l=r.length;for(let s=0;s<l;s++){let c=s,u=(s+1)%l,d=r[c],m=r[u],p=o(d,m);delete h[p];let f=o(m,d),C=h[f];if(C){let r=C.tri,o=C.index,l=r.normals,s=l.length,d=r.faceNormal;if(.25>Math.abs(r.faceNormal.dot(e.faceNormal)))continue;f in h&&(t.push(C),delete h[f]);let m=(o+1)%s;i[c]&&l[m]&&i[c]!==l[m]&&(l[m].norm.add(i[c].norm),i[c].norm=l[m].norm);let p=i[c]||l[m];null===p&&(p={norm:new a.Vector3},g.push(p.norm)),null===i[c]&&(i[c]=p,p.norm.add(n)),null===l[m]&&(l[m]=p,p.norm.add(d)),i[u]&&l[o]&&i[u]!==l[o]&&(l[o].norm.add(i[u].norm),i[u].norm=l[o].norm);let M=i[u]||l[o];null===M&&(M={norm:new a.Vector3},g.push(M.norm)),null===i[u]&&(i[u]=M,M.norm.add(n)),null===l[o]&&(l[o]=M,M.norm.add(d))}}}}for(let e=0,t=g.length;e<t;e++)g[e].normalize()}(e.faces,e.lineSegments,t)}let s=e.group;return e.faces.length>0&&s.add(C(this.loader,e.faces,3,!1,e.totalFaces)),e.lineSegments.length>0&&s.add(C(this.loader,e.lineSegments,2)),e.conditionalSegments.length>0&&s.add(C(this.loader,e.conditionalSegments,2,!0)),s}hasCachedModel(e){return null!==e&&e.toLowerCase() in this._cache}async getCachedModel(e){if(!(null!==e&&this.hasCachedModel(e)))return null;{let t=e.toLowerCase();return(await this._cache[t]).clone()}}async loadModel(e){let t=this.parseCache,r=e.toLowerCase();if(this.hasCachedModel(e))return this.getCachedModel(e);{await t.ensureDataLoaded(e);let a=t.getData(e),i=this.processIntoMesh(a);return this.hasCachedModel(e)?this.getCachedModel(e):(d(a.type)&&(this._cache[r]=i),(await i).clone())}}async parseModel(e){let t=this.parseCache.parse(e);return d(t.type)&&this.hasCachedModel(t.fileName)?this.getCachedModel(t.fileName):this.processIntoMesh(t)}}function f(e,t){return e.colorCode===t.colorCode?0:e.colorCode<t.colorCode?-1:1}function C(e,t,r,i=!1,n=null){t.sort(f),null===n&&(n=t.length);let s=new Float32Array(r*n*3),u=3===r?new Float32Array(r*n*3):null,d=[],h=Array(6),g=new a.BufferGeometry,m=null,p=0,C=0,M=0;for(let n=0,c=t.length;n<c;n++){let c=t[n],f=c.vertices;4===f.length&&(h[0]=f[0],h[1]=f[1],h[2]=f[2],h[3]=f[0],h[4]=f[2],h[5]=f[3],f=h);for(let e=0,t=f.length;e<t;e++){let t=f[e],r=M+3*e;s[r+0]=t.x,s[r+1]=t.y,s[r+2]=t.z}if(3===r){if(!c.faceNormal){let e=f[0],t=f[1],r=f[2];o.subVectors(t,e),l.subVectors(r,t),c.faceNormal=new(0,a.Vector3)().crossVectors(o,l).normalize()}let e=c.normals;4===e.length&&(h[0]=e[0],h[1]=e[1],h[2]=e[2],h[3]=e[0],h[4]=e[2],h[5]=e[3],e=h);for(let t=0,r=e.length;t<r;t++){let r=c.faceNormal;e[t]&&(r=e[t].norm);let a=M+3*t;u[a+0]=r.x,u[a+1]=r.y,u[a+2]=r.z}}if(m!==c.colorCode){null!==m&&g.addGroup(p,C,d.length-1);let t=c.material;if(null!==t){if(3===r)d.push(t);else if(2===r){if(i){let r=e.edgeMaterialCache.get(t);d.push(e.conditionalEdgeMaterialCache.get(r))}else d.push(e.edgeMaterialCache.get(t))}}else d.push(c.colorCode);m=c.colorCode,p=M/3,C=f.length}else C+=f.length;M+=3*f.length}C>0&&g.addGroup(p,1/0,d.length-1),g.setAttribute("position",new a.BufferAttribute(s,3)),null!==u&&g.setAttribute("normal",new a.BufferAttribute(u,3));let b=null;if(2===r?b=i?new c(g,1===d.length?d[0]:d):new a.LineSegments(g,1===d.length?d[0]:d):3===r&&(b=new a.Mesh(g,1===d.length?d[0]:d)),i){b.isConditionalLine=!0;let e=new Float32Array(6*t.length),r=new Float32Array(6*t.length),i=new Float32Array(6*t.length);for(let a=0,n=t.length;a<n;a++){let n=t[a],o=n.vertices,l=n.controlPoints,s=l[0],c=l[1],u=o[0],d=o[1],h=6*a;e[h+0]=s.x,e[h+1]=s.y,e[h+2]=s.z,e[h+3]=s.x,e[h+4]=s.y,e[h+5]=s.z,r[h+0]=c.x,r[h+1]=c.y,r[h+2]=c.z,r[h+3]=c.x,r[h+4]=c.y,r[h+5]=c.z,i[h+0]=d.x-u.x,i[h+1]=d.y-u.y,i[h+2]=d.z-u.z,i[h+3]=d.x-u.x,i[h+4]=d.y-u.y,i[h+5]=d.z-u.z}g.setAttribute("control0",new a.BufferAttribute(e,3,!1)),g.setAttribute("control1",new a.BufferAttribute(r,3,!1)),g.setAttribute("direction",new a.BufferAttribute(i,3,!1))}return b}class M extends a.Loader{constructor(e){super(e),this.materials=[],this.materialLibrary={},this.edgeMaterialCache=new WeakMap,this.conditionalEdgeMaterialCache=new WeakMap,this.partsCache=new p(this),this.fileMap={},this.setMaterials([]),this.smoothNormals=!0,this.partsLibraryPath="",this.missingColorMaterial=new a.MeshStandardMaterial({name:a.Loader.DEFAULT_MATERIAL_NAME,color:16711935,roughness:.3,metalness:0}),this.missingEdgeColorMaterial=new a.LineBasicMaterial({name:a.Loader.DEFAULT_MATERIAL_NAME,color:16711935}),this.missingConditionalEdgeColorMaterial=new s({name:a.Loader.DEFAULT_MATERIAL_NAME,fog:!0,color:16711935}),this.edgeMaterialCache.set(this.missingColorMaterial,this.missingEdgeColorMaterial),this.conditionalEdgeMaterialCache.set(this.missingEdgeColorMaterial,this.missingConditionalEdgeColorMaterial)}setPartsLibraryPath(e){return this.partsLibraryPath=e,this}async preloadMaterials(e){let t=new a.FileLoader(this.manager);t.setPath(this.path),t.setRequestHeader(this.requestHeader),t.setWithCredentials(this.withCredentials);let r=await t.loadAsync(e),i=/^0 !COLOUR/,n=r.split(/[\n\r]/g),o=[];for(let e=0,t=n.length;e<t;e++){let t=n[e];if(i.test(t)){let e=t.replace(i,""),r=this.parseColorMetaDirective(new h(e));o.push(r)}}this.setMaterials(o)}load(e,t,r,i){let n=new a.FileLoader(this.manager);n.setPath(this.path),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(e,r=>{this.partsCache.parseModel(r,this.materialLibrary).then(r=>{this.applyMaterialsToMesh(r,"16",this.materialLibrary,!0),this.computeBuildingSteps(r),r.userData.fileName=e,t(r)}).catch(i)},r,i)}parse(e,t){this.partsCache.parseModel(e,this.materialLibrary).then(e=>{this.applyMaterialsToMesh(e,"16",this.materialLibrary,!0),this.computeBuildingSteps(e),e.userData.fileName="",t(e)})}setMaterials(e){this.materialLibrary={},this.materials=[];for(let t=0,r=e.length;t<r;t++)this.addMaterial(e[t]);return this.addMaterial(this.parseColorMetaDirective(new h("Main_Colour CODE 16 VALUE #FF8080 EDGE #333333"))),this.addMaterial(this.parseColorMetaDirective(new h("Edge_Colour CODE 24 VALUE #A0A0A0 EDGE #333333"))),this}setFileMap(e){return this.fileMap=e,this}addMaterial(e){let t=this.materialLibrary;return t[e.userData.code]||(this.materials.push(e),t[e.userData.code]=e),this}getMaterial(e){if(e.startsWith("0x2")){let t=e.substring(3);return this.parseColorMetaDirective(new h("Direct_Color_"+t+" CODE -1 VALUE #"+t+" EDGE #"+t))}return this.materialLibrary[e]||null}applyMaterialsToMesh(e,t,r,a=!1){let i=this,n="16"===t;function o(e,o){if(n&&!(o in r)&&!a)return o;let l=e.isLineSegments||e.isConditionalLine;(!l&&"16"===o||l&&"24"===o)&&(o=t);let s=null;if(o in r)s=r[o];else{if(!a)return o;null===(s=i.getMaterial(o))&&(console.warn(`LDrawLoader: Material properties for code ${o} not available.`),s=i.missingColorMaterial)}return e.isLineSegments&&(s=i.edgeMaterialCache.get(s),e.isConditionalLine&&(s=i.conditionalEdgeMaterialCache.get(s))),s}e.traverse(e=>{if(e.isMesh||e.isLineSegments){if(Array.isArray(e.material))for(let t=0,r=e.material.length;t<r;t++)e.material[t].isMaterial||(e.material[t]=o(e,e.material[t]));else e.material.isMaterial||(e.material=o(e,e.material))}})}getMainMaterial(){return this.getMaterial("16")}getMainEdgeMaterial(){let e=this.getMaterial("24");return e?this.edgeMaterialCache.get(e):null}parseColorMetaDirective(e){let t=null,r="#FF00FF",i="#FF00FF",o=1,l=!1,c=0,u=0,d=null,g=e.getToken();if(!g)throw Error('LDrawLoader: Material name was expected after "!COLOUR tag'+e.getLineNumberString()+".");let m=null;for(;m=e.getToken();)if(!f(m))switch(m.toUpperCase()){case"CODE":t=e.getToken();break;case"VALUE":if((r=e.getToken()).startsWith("0x"))r="#"+r.substring(2);else if(!r.startsWith("#"))throw Error("LDrawLoader: Invalid color while parsing material"+e.getLineNumberString()+".");break;case"EDGE":if((i=e.getToken()).startsWith("0x"))i="#"+i.substring(2);else if(!i.startsWith("#")){if(!(d=this.getMaterial(i)))throw Error("LDrawLoader: Invalid edge color while parsing material"+e.getLineNumberString()+".");d=this.edgeMaterialCache.get(d)}break;case"ALPHA":if(isNaN(o=parseInt(e.getToken())))throw Error("LDrawLoader: Invalid alpha value in material definition"+e.getLineNumberString()+".");(o=Math.max(0,Math.min(1,o/255)))<1&&(l=!0);break;case"LUMINANCE":if(!f(e.getToken()))throw Error("LDrawLoader: Invalid luminance value in material definition"+h.getLineNumberString()+".");break;case"CHROME":u=1;break;case"PEARLESCENT":u=2;break;case"RUBBER":u=3;break;case"MATTE_METALLIC":u=4;break;case"METAL":u=5;break;case"MATERIAL":e.setToEnd();break;default:throw Error('LDrawLoader: Unknown token "'+m+'" while parsing material'+e.getLineNumberString()+".")}let p=null;switch(u){case 0:p=new a.MeshStandardMaterial({roughness:.3,metalness:0});break;case 2:p=new a.MeshStandardMaterial({roughness:.3,metalness:.25});break;case 1:p=new a.MeshStandardMaterial({roughness:0,metalness:1});break;case 3:p=new a.MeshStandardMaterial({roughness:.9,metalness:0});break;case 4:p=new a.MeshStandardMaterial({roughness:.8,metalness:.4});break;case 5:p=new a.MeshStandardMaterial({roughness:.2,metalness:.85})}if(p.color.setStyle(r,n),p.transparent=l,p.premultipliedAlpha=!0,p.opacity=o,p.depthWrite=!l,p.polygonOffset=!0,p.polygonOffsetFactor=1,0!==c&&p.emissive.setStyle(r,n).multiplyScalar(c),!d){(d=new a.LineBasicMaterial({color:new(0,a.Color)().setStyle(i,n),transparent:l,opacity:o,depthWrite:!l})).color,d.userData.code=t,d.name=g+" - Edge";let e=new s({fog:!0,transparent:l,depthWrite:!l,color:new(0,a.Color)().setStyle(i,n),opacity:o});e.userData.code=t,e.name=g+" - Conditional Edge",this.conditionalEdgeMaterialCache.set(d,e)}return p.userData.code=t,p.name=g,this.edgeMaterialCache.set(p,d),this.addMaterial(p),p;function f(e){let t;return!isNaN(t=e.startsWith("LUMINANCE")?parseInt(e.substring(9)):parseInt(e))&&(c=Math.max(0,Math.min(1,t/255)),!0)}}computeBuildingSteps(e){let t=0;e.traverse(e=>{e.isGroup&&(e.userData.startingBuildingStep&&t++,e.userData.buildingStep=t)}),e.userData.numBuildingSteps=t+1}}}),n("9hfHi",function(t,r){e(t.exports,"LDrawUtils",()=>o);var a=i("ilwiq"),n=i("7ePFa");class o{static mergeObject(e){function t(e,t,r){let a=r[e.uuid];a?a.arr.push(t):r[e.uuid]={mat:e,arr:[t]}}function r(e,t){if(!e)return;let r=e.array,a=Math.floor(r.length/3),i=0;for(let e=0;e<a;e++){let e=r[i],a=r[i+1],n=r[i+2];r[i]=r[i+3],r[i+1]=r[i+4],r[i+2]=r[i+5],r[i+3]=e,r[i+4]=a,r[i+5]=n,i+=3*t}}let i={},o={},l={};e.updateMatrixWorld(!0);let s=new a.Matrix3;e.traverse(e=>{if(e.isMesh|e.isLineSegments){let n=e.isMesh?3:2,c=e.geometry.clone();0>e.matrixWorld.determinant()&&(r(c.attributes.position,n),r(c.attributes.normal,n)),c.applyMatrix4(e.matrixWorld),e.isConditionalLine&&(c.attributes.control0.applyMatrix4(e.matrixWorld),c.attributes.control1.applyMatrix4(e.matrixWorld),s.getNormalMatrix(e.matrixWorld),c.attributes.direction.applyNormalMatrix(s));let u=e.isMesh?i:e.isConditionalLine?l:o;if(Array.isArray(e.material))for(let r in c.groups){let i=c.groups[r];t(e.material[i.materialIndex],function(e,t,r,i){let n=new a.BufferGeometry,o=e.getAttribute("position").array,l=3===r?e.getAttribute("normal").array:null,s=Math.min(t.count,Math.floor(o.length/3)-t.start),c=3*t.start,u=(t.start+s)*3,d=o.subarray(c,u),h=null!==l?l.subarray(c,u):null;if(n.setAttribute("position",new a.BufferAttribute(d,3)),null!==h&&n.setAttribute("normal",new a.BufferAttribute(h,3)),i){let t=e.getAttribute("control0").array.subarray(c,u),r=e.getAttribute("control1").array.subarray(c,u),i=e.getAttribute("direction").array.subarray(c,u);n.setAttribute("control0",new a.BufferAttribute(t,3,!1)),n.setAttribute("control1",new a.BufferAttribute(r,3,!1)),n.setAttribute("direction",new a.BufferAttribute(i,3,!1))}return n}(c,i,n,e.isConditionalLine),u)}else t(e.material,c,u)}});let c=new a.Group;for(let e of Object.keys(i)){let t=i[e],r=(0,n.mergeGeometries)(t.arr);c.add(new a.Mesh(r,t.mat))}for(let e of Object.keys(o)){let t=o[e],r=(0,n.mergeGeometries)(t.arr);c.add(new a.LineSegments(r,t.mat))}for(let e of Object.keys(l)){let t=l[e],r=(0,n.mergeGeometries)(t.arr),i=new a.LineSegments(r,t.mat);i.isConditionalLine=!0,c.add(i)}return c.userData.constructionStep=0,c.userData.numConstructionSteps=1,c}}});
//# sourceMappingURL=index.5fc992bc.js.map
